<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twyne Seeding Simulation</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-card: #232b3b;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --accent-blue: #4a9bb5;
            --accent-orange: #ef6c00;
            --accent-green: #4caf50;
            --accent-purple: #9c7cf4;
            --accent-amber: #e0a732;
            --border-color: #3a4556;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: 100vh;
            transition: grid-template-columns 0.3s ease;
        }
        .container.sidebar-closed {
            grid-template-columns: 0px 1fr;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            padding: 24px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 100vh;
            position: sticky;
            top: 0;
            transition: padding 0.3s ease, opacity 0.2s ease;
        }
        .sidebar-closed .sidebar {
            padding: 0;
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .sidebar-header span {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            font-weight: 600;
        }
        .sidebar-toggle {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-toggle:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .sidebar-open-btn {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 8px;
            border: 1px solid rgba(156,124,244,0.35);
            background: rgba(156,124,244,0.08);
            color: var(--accent-purple);
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            margin-bottom: 16px;
            align-self: flex-start;
        }
        .sidebar-open-btn:hover {
            background: rgba(156,124,244,0.15);
            border-color: rgba(156,124,244,0.5);
        }
        .sidebar-closed .sidebar-open-btn {
            display: flex;
        }

        .sidebar h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--accent-blue);
        }

        .sidebar .subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }

        details.section summary.section-header {
            list-style: none;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            margin-bottom: 0;
            padding: 10px 12px;
            border-radius: 6px;
            border-bottom: none;
            background: rgba(255, 255, 255, 0.03);
            transition: background 0.15s;
        }
        details.section summary.section-header:hover {
            background: rgba(255, 255, 255, 0.06);
        }
        details.section summary.section-header::-webkit-details-marker {
            display: none;
        }
        details.section summary.section-header::after {
            content: '▾';
            font-size: 1rem;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }
        details:not([open]).section summary.section-header::after {
            content: '▸';
        }
        details[open].section summary.section-header {
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            border-radius: 6px 6px 0 0;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .input-wrapper.has-prefix input {
            padding-left: 24px;
        }

        .input-wrapper.has-suffix input {
            padding-right: 28px;
        }

        .input-prefix, .input-suffix {
            position: absolute;
            color: var(--text-secondary);
            font-size: 0.85rem;
            pointer-events: none;
        }

        .input-prefix {
            left: 10px;
        }

        .input-suffix {
            right: 10px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-display {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 4px 0;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .stat-value.positive {
            color: var(--accent-green);
        }

        .stat-value.warning {
            color: var(--accent-orange);
        }

        /* Main Content */
        .main {
            padding: 24px 32px;
            overflow-y: auto;
        }

        .main h2 {
            font-size: 1.25rem;
            margin-bottom: 8px;
        }

        .main .description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        .chart-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hf-range-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
        }

        .hf-range-controls label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .hf-range-controls input {
            width: 80px;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 14px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #tvlTradeoffTable th {
            background: rgba(156,124,244,0.1);
            color: var(--accent-purple);
        }

        th[data-tip] {
            cursor: help;
        }

        #tip {
            position: fixed;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.75rem;
            font-weight: 400;
            line-height: 1.5;
            max-width: 260px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 9999;
        }

        td {
            font-variant-numeric: tabular-nums;
        }

        #tvlTradeoffTable {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            width: 100%;
        }

        #tvlTradeoffTable colgroup {
            display: none;
        }

        #tvlTradeoffTable thead,
        #tvlTradeoffTable tbody {
            display: contents;
        }

        #tvlTradeoffTable tr {
            display: grid;
            grid-template-columns: subgrid;
            grid-column: 1 / -1;
        }

        #tvlTradeoffTable th,
        #tvlTradeoffTable td {
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 11px 16px;
        }


        #tvlTradeoffTable tbody tr:not(.box-single) {
            cursor: pointer;
        }
        #tvlTradeoffTable tbody tr:not(.box-single):hover td:last-child .row-select-icon {
            opacity: 0.4;
        }
        #tvlTradeoffTable tbody tr.selected td:last-child .row-select-icon {
            opacity: 1;
        }
        .row-select-icon {
            opacity: 0;
            transition: opacity 0.15s ease;
            color: var(--accent-purple);
            font-size: 0.7rem;
            margin-left: 12px;
            vertical-align: middle;
        }

        #tvlTradeoffTable tr.box-single {
            border: 1px solid rgba(156,124,244,0.3);
            border-radius: 8px;
            margin-bottom: 6px;
            background: rgba(156,124,244,0.03);
        }

        #tvlTradeoffTable tr.box-single td {
            border-bottom: none;
        }

        #tvlTradeoffTable tr.box-top {
            border: 1px solid rgba(156,124,244,0.3);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            background: rgba(156,124,244,0.04);
        }

        #tvlTradeoffTable tr.box-mid {
            border-left: 1px solid rgba(156,124,244,0.3);
            border-right: 1px solid rgba(156,124,244,0.3);
            background: rgba(156,124,244,0.03);
        }

        #tvlTradeoffTable tr.box-bottom {
            border-left: 1px solid rgba(156,124,244,0.3);
            border-right: 1px solid rgba(156,124,244,0.3);
            border-bottom: 1px solid rgba(156,124,244,0.3);
            border-radius: 0 0 8px 8px;
            background: rgba(156,124,244,0.03);
        }

        #tvlTradeoffTable tr.box-bottom td {
            border-bottom: none;
        }

        .table-with-labels {
            display: flex;
            gap: 0;
        }

        .table-with-labels table {
            flex: 1;
            min-width: 0;
        }

        .table-labels {
            width: 56px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            padding-top: 36px; /* skip header row */
        }

        .table-labels .label-cell {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .table-labels .label-cell img {
            width: 40px;
        }

        tr:hover td {
            background: rgba(74, 155, 181, 0.1);
        }

        .aave-badge {
            display: inline-block;
            background: var(--accent-orange);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        @media (max-width: 1200px) {
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Position Scenarios */
        #positionComparison .scenario-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .scenario-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            table-layout: fixed;
        }
        .scenario-table col:nth-child(1) { width: 14%; }
        .scenario-table col:nth-child(2) { width: 12%; }
        .scenario-table col:nth-child(3) { width: 14%; }
        .scenario-table col:nth-child(4) { width: 14%; }
        .scenario-table col:nth-child(5) { width: 10%; }
        .scenario-table col:nth-child(6) { width: 14%; }
        .scenario-table col:nth-child(7) { width: 22%; }
        .scenario-table th {
            padding: 10px 14px;
            font-size: 0.7rem;
        }
        .scenario-table td {
            padding: 9px 14px;
        }
        .rate-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .rate-table th {
            padding: 8px 16px;
            font-size: 0.7rem;
            text-align: center;
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .rate-table td {
            padding: 8px 16px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }
        .rate-table th:first-child,
        .rate-table td:first-child {
            text-align: left;
        }

        .scenario-card {
            border-radius: 12px;
            padding: 16px;
        }
        .scenario-card.aave {
            background: rgba(239, 108, 0, 0.06);
            border: 1px solid rgba(239, 108, 0, 0.2);
        }
        .scenario-card.aave th {
            background: rgba(239, 108, 0, 0.1);
            color: var(--accent-orange);
        }
        .scenario-card.twyne {
            background: rgba(156, 124, 244, 0.06);
            border: 1px solid rgba(156, 124, 244, 0.2);
        }
        .scenario-card.twyne th {
            background: rgba(156, 124, 244, 0.1);
            color: var(--accent-purple);
        }
        .delta-positive { color: var(--accent-green); font-weight: 600; }
        .delta-negative { color: var(--accent-orange); font-weight: 600; }
        .beyond-aave-header td {
            border-top: 2px dashed var(--border-color);
            padding-top: 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        .scenario-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .scenario-controls label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .scenario-controls input,
        .scenario-controls select {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: relative;
                max-height: none;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <span>Parameters</span>
                <button class="sidebar-toggle" id="sidebarToggle" title="Close sidebar">&#x2039;</button>
            </div>
            <div class="section">
                <div class="section-header">Rates</div>
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-left: 3px solid var(--accent-purple); border-radius: 8px; padding: 12px;">
                    <div class="input-row">
                        <div class="input-group">
                            <label>Staking APY</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="stethStaking" value="3.00" step="0.1" min="0" max="20">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Lending APY</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="stethLending" value="0" step="0.1" min="0" max="10">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Borrow APY</label>
                        <div class="input-wrapper has-suffix">
                            <input type="number" id="ethBorrow" value="2.20" step="0.1" min="0" max="20">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="betaSafe" value="100">
            </div>

            <div class="section">
                <div class="section-header">Liquidation LTVs</div>
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-left: 3px solid var(--accent-purple); border-radius: 8px; padding: 12px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                        <img src="icons/aave_logo_light.png" alt="Aave" style="width: 64px;">
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Liq LTV</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="liqLtvE" value="95" step="1" min="70" max="98">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Borrow LTV</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="borrowLtvE" value="93" step="1" min="60" max="95">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-left: 3px solid var(--accent-purple); border-radius: 8px; padding: 12px; margin-top: 8px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                        <img src="icons/twyne_logo_white_full.png" alt="Twyne" style="width: 64px;">
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Liq LTV</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="liqLtvT" value="98" step="1" min="90" max="99">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Borrow LTV</label>
                            <span class="stat-value" id="summaryBorrowLtvTwyne" style="font-size: 14px; line-height: 32px; color: var(--accent-purple);">—</span>
                        </div>
                    </div>
                    <div class="stat-display" style="margin-top: 8px;">
                        <div class="stat-row">
                            <span class="stat-label">Credit Requirements</span>
                            <span class="stat-value" id="psiValue">3.16%</span>
                        </div>
                    </div>
                </div>
            </div>

            <details class="section" style="margin-bottom: 0; margin-top: 12px; --detail-accent: var(--accent-purple);">
                <summary class="section-header" style="border-left: 3px solid var(--accent-purple);">Interest Rate</summary>
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-left: 3px solid var(--accent-purple); border-radius: 8px; padding: 12px; margin-top: 8px;">
                    <div class="input-row">
                        <div class="input-group">
                            <label>I_min</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="iMin" value="0" step="0.1" min="0" max="10">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>I_max</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="iMax" value="15" step="1" min="1" max="50">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>I_0 (kink rate)</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="i0" value="0.8" step="0.1" min="0" max="10">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>u_0 (kink util)</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="u0" value="90" step="1" min="50" max="99">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>gamma</label>
                            <input type="number" id="gamma" value="32" step="1" min="1" max="100">
                        </div>
                        <div class="input-group">
                            <label>Utilization</label>
                            <div class="input-wrapper has-suffix">
                                <input type="number" id="utilization" value="90" step="1" min="80" max="100">
                                <span class="input-suffix">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </details>
        </aside>

        <main class="main">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 20px; margin-bottom: 16px;">
                <h2 style="margin: 0; color: var(--accent-purple);">Seeding Simulator</h2>
                <img src="icons/twyne_logo_white_full.png" alt="Twyne" style="height: 36px;">
            </div>

            <button class="sidebar-open-btn" id="sidebarOpen" title="Open sidebar">&#x203A; Parameters</button>
            <!-- Position Scenarios: LRT / WETH Loop -->
            <section id="positionComparison" style="margin-top: 40px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <h2 style="margin-bottom: 4px;">Position Scenarios: LRT / WETH Loop</h2>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-left: 3px solid var(--accent-amber); border-radius: 8px;">
                        <label style="font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap;">Borrower Equity</label>
                        <div class="input-wrapper has-prefix" style="max-width: 160px;">
                            <span class="input-prefix">$</span>
                            <input type="text" id="borrowerEquity" value="1,000,000" inputmode="numeric">
                        </div>
                    </div>
                </div>
                <p class="description">Compare a looped LRT/WETH position on Aave alone vs with Twyne credit delegation.</p>

                <div class="scenario-grid">
                    <!-- Scenario A: Aave Only -->
                    <div class="scenario-card aave">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <img src="icons/aave_logo_light.png" alt="Aave" style="width: 56px;">
                            <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-orange); font-weight: 600;">Scenario A — Aave Only</span>
                        </div>
                        <table class="scenario-table" id="scenarioATable">
                            <colgroup><col><col><col><col><col><col><col></colgroup>
                            <thead>
                                <tr>
                                    <th>Credit-LP Req.</th>
                                    <th>Leverage</th>
                                    <th>Collateral</th>
                                    <th>Debt</th>
                                    <th>LTV</th>
                                    <th>Net APY</th>
                                    <th>Delta</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <!-- Scenario B: With Twyne -->
                    <div class="scenario-card twyne">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <img src="icons/twyne_logo_white_full.png" alt="Twyne" style="width: 56px;">
                            <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-purple); font-weight: 600;">Scenario B — With Twyne</span>
                        </div>
                        <table class="scenario-table" id="scenarioBTable">
                            <colgroup><col><col><col><col><col><col><col></colgroup>
                            <thead>
                                <tr>
                                    <th>Credit-LP Req.</th>
                                    <th>Leverage</th>
                                    <th>Collateral</th>
                                    <th>Debt</th>
                                    <th>LTV</th>
                                    <th>Net APY</th>
                                    <th id="scenarioBDeltaHeader">Delta</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div style="margin-top: 24px; background: rgba(74, 155, 181, 0.06); border: 1px solid rgba(74, 155, 181, 0.2); border-radius: 10px; padding: 16px 20px; line-height: 1.7; font-size: 0.85rem; color: var(--text-secondary);">
                    <strong style="color: var(--text-primary);">Why this matters for LRT issuers</strong><br>
                    On Aave, <strong style="color: var(--accent-orange);">$1 of LRT becomes ~$14 in looped TVL</strong>. But most depositors don't max out their leverage, so that borrowing capacity sits unused. With Twyne, idle depositors can delegate that capacity to active loopers: the creditor earns delegation yield on top of their staking and lending returns, while the borrower gets access to leverage beyond Aave's ceiling or a larger safety buffer against liquidation. The same Aave rails, more TVL per dollar, and a direct growth multiplier for the LRT issuer.
                </div>

                <div style="display: flex; align-items: center; gap: 16px; margin-top: 32px; margin-bottom: 16px;">
                    <h3 style="margin: 0;">Borrow Rate Sensitivity</h3>
                    <div style="display: flex; background: var(--bg-sidebar); border-radius: 6px; overflow: hidden; border: 1px solid var(--border-color);">
                        <button id="sensToggle_rseth" onclick="setSensToken('rseth')" style="padding: 4px 12px; font-size: 0.75rem; border: none; cursor: pointer; background: var(--accent-purple); color: #fff;">rsETH</button>
                        <button id="sensToggle_eeth" onclick="setSensToken('eeth')" style="padding: 4px 12px; font-size: 0.75rem; border: none; cursor: pointer; background: transparent; color: var(--text-muted);">eETH</button>
                        <button id="sensToggle_steth" onclick="setSensToken('steth')" style="padding: 4px 12px; font-size: 0.75rem; border: none; cursor: pointer; background: transparent; color: var(--text-muted);">stETH</button>
                    </div>
                </div>

                <!-- Rate Sensitivity Chart -->
                <div style="background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color);">
                    <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 12px;">Net APY vs Rate Spread</div>
                    <div id="rateSensitivityChart" style="width: 100%; height: 400px;"></div>
                    <div id="sensitivitySourceText" style="font-size: 0.7rem; color: #6b7280; margin-top: 4px; text-align: right;">Source: DeFi Llama, May '24 – Feb '26 — WETH borrow rate (Aave V3) · rsETH yield (Kelp DAO)</div>
                </div>

                <!-- Sensitivity Table -->
                <div style="margin-top: 20px; background: var(--bg-card); border-radius: 12px; padding: 16px 20px; border: 1px solid var(--border-color);">
                    <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 10px;">ETH Borrow Rate Sensitivity</div>
                    <div style="overflow-x: auto;">
                        <table class="rate-table" id="sensitivityTable">
                            <thead><tr id="sensitivityHeader"></tr></thead>
                            <tbody id="sensitivityBody"></tbody>
                        </table>
                    </div>
                </div>

            </section>

            <!-- Historical Analysis -->
            <section class="card" style="margin-top: 24px;">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 8px;">
                    <h3 style="margin: 0;">Historical Analysis</h3>
                </div>
                <div id="histCombinedChart" style="width: 100%; height: 680px;"></div>
            </section>

            <details style="margin-top: 40px; background: rgba(156,124,244,0.06); border: 1px solid rgba(156,124,244,0.2); border-radius: 12px;">
                <summary style="cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; padding: 16px 20px;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.3rem;">Seeding Overview</h2>
                        <p class="description" style="margin: 4px 0 0;">TVL generation, leverage ranges, and trade-off analysis.</p>
                    </div>
                    <span style="font-size: 1rem; color: var(--text-secondary); flex-shrink: 0; margin-left: 12px;">&#9662;</span>
                </summary>
                <div style="padding: 0 20px 16px;">

                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border-color); border-left: 3px solid var(--accent-blue); border-radius: 8px;">
                        <label style="font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap;">CLP Deposited</label>
                        <div class="input-wrapper has-prefix" style="max-width: 180px;">
                            <span class="input-prefix">$</span>
                            <input type="text" id="clpDeposited" value="1,000,000" inputmode="numeric">
                        </div>
                    </div>

            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 24px;">
                <!-- Seed box (centered, compact) -->
                <div style="background: rgba(74, 155, 181, 0.08); border: 1px solid rgba(74, 155, 181, 0.25); border-radius: 10px; padding: 12px 24px; display: inline-flex; align-items: center; gap: 16px;">
                    <span style="display: inline-flex; align-items: center; gap: 6px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">Seed Amount</span>
                        <strong style="color: var(--accent-blue); font-size: 1.05rem;" id="topSeedAmount">—</strong>
                    </span>
                    <span style="width: 1px; height: 18px; background: var(--border-color);"></span>
                    <span style="display: inline-flex; align-items: center; gap: 6px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">Creditor Yield</span>
                        <strong style="color: #4a9bb5; font-size: 1.05rem;" id="topClpYield">—</strong>
                    </span>
                </div>
                <!-- Connector: forking lines with label -->
                <div style="position: relative; width: 100%; height: 80px;">
                    <!-- Center vertical stem -->
                    <div style="position: absolute; left: 50%; top: 0; width: 2px; height: 24px; background: var(--border-color); transform: translateX(-50%);"></div>
                    <!-- Horizontal bar -->
                    <div style="position: absolute; left: 25%; right: 25%; top: 24px; height: 2px; background: var(--border-color);"></div>
                    <!-- Left drop -->
                    <div style="position: absolute; left: 25%; top: 24px; width: 2px; height: 56px; background: var(--border-color);"></div>
                    <!-- Right drop -->
                    <div style="position: absolute; right: 25%; top: 24px; width: 2px; height: 56px; background: var(--border-color);"></div>
                    <!-- Label -->
                    <div style="position: absolute; top: 42px; left: 50%; transform: translateX(-50%); white-space: nowrap; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); background: var(--bg-primary); padding: 2px 16px;">credit delegation unlocks</div>
                </div>
                <!-- Result cards -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; width: 100%;">
                    <div style="background: rgba(156, 124, 244, 0.08); border: 1px solid rgba(156, 124, 244, 0.25); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-purple);">Generated TVL Range</div>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.7rem; color: var(--text-secondary);">
                                <span id="tvlToggleLabel">$</span>
                                <div id="tvlToggle" onclick="toggleTvlMode()" style="width: 32px; height: 18px; background: var(--border-color); border-radius: 9px; position: relative; cursor: pointer; transition: background 0.2s;">
                                    <div id="tvlToggleKnob" style="width: 14px; height: 14px; background: var(--text-secondary); border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: left 0.2s;"></div>
                                </div>
                                <span id="tvlToggleLabelRight">x</span>
                            </label>
                        </div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-primary);"><span id="summaryMaxTvl">—</span> <span style="font-size: 1rem; color: var(--text-secondary);">to</span> <span id="summaryMinTvl">—</span></div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">from <span id="summaryClpDeposited">—</span> creditor deposit</div>
                    </div>
                    <div style="background: rgba(156, 124, 244, 0.08); border: 1px solid rgba(156, 124, 244, 0.25); border-radius: 12px; padding: 20px;">
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-purple); margin-bottom: 8px;">Leverage Range</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-primary);"><span id="summaryLevMin">—</span> <span style="font-size: 1rem; color: var(--text-secondary);">to</span> <span id="summaryLevMax">—</span></div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">Aave alone: <span id="summaryAaveLev">—</span></div>
                    </div>
                </div>
            </div>

            <!-- Mini charts: TVL and Leverage vs Borrow LTV -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div style="background: rgba(156, 124, 244, 0.06); border: 1px solid rgba(156, 124, 244, 0.2); border-radius: 12px; padding: 16px;">
                    <div id="tvlChartTitle" style="font-size: 0.8rem; font-weight: 600; color: var(--accent-purple); margin-bottom: 8px;">Generated TVL by Borrow LTV</div>
                    <div id="tvlByLtvChart" style="width: 100%; height: 180px;"></div>
                </div>
                <div style="background: rgba(156, 124, 244, 0.06); border: 1px solid rgba(156, 124, 244, 0.2); border-radius: 12px; padding: 16px;">
                    <div style="font-size: 0.8rem; font-weight: 600; color: var(--accent-purple); margin-bottom: 8px;">Leverage by Borrow LTV</div>
                    <div id="levByLtvChart" style="width: 100%; height: 180px;"></div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 0 0 20px;">
                <div style="display: flex; gap: 10px; align-items: flex-start; background: rgba(156, 124, 244, 0.06); border: 1px solid rgba(156, 124, 244, 0.2); border-radius: 8px; padding: 12px 14px;">
                    <span style="font-size: 0.85rem; flex-shrink: 0; margin-top: 1px;">&#8505;</span>
                    <span style="color: var(--text-secondary); font-size: 0.8rem; line-height: 1.6;">Higher liquidation LTVs require more credit per borrower, reducing supported TVL. Realistic TVL falls between the extremes.</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: flex-start; background: rgba(156, 124, 244, 0.06); border: 1px solid rgba(156, 124, 244, 0.2); border-radius: 8px; padding: 12px 14px;">
                    <span style="font-size: 0.85rem; flex-shrink: 0; margin-top: 1px;">&#8505;</span>
                    <span style="color: var(--text-secondary); font-size: 0.8rem; line-height: 1.6;">Higher leverage reduces total supported TVL, but increases TVL generated per unit of borrower equity.</span>
                </div>
            </div>

            <!-- TVL vs LTV Tradeoff Table -->
            <div class="chart-container" style="background: rgba(156,124,244,0.06); border: 1px solid rgba(156,124,244,0.2);">
                <div style="display: flex; align-items: center; justify-content: space-between; padding-right: 56px;">
                    <div class="chart-title" style="color: var(--accent-purple);">TVL Breakdown by LTV</div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Rows</span>
                        <button id="tradeoffRowMinus" style="width: 26px; height: 26px; border-radius: 6px; border: 1px solid rgba(156,124,244,0.3); background: rgba(156,124,244,0.1); color: var(--accent-purple); font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1;">−</button>
                        <span id="tradeoffRowCount" style="font-size: 0.8rem; color: var(--text-primary); min-width: 16px; text-align: center; font-weight: 600;">5</span>
                        <button id="tradeoffRowPlus" style="width: 26px; height: 26px; border-radius: 6px; border: 1px solid rgba(156,124,244,0.3); background: rgba(156,124,244,0.1); color: var(--accent-purple); font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1;">+</button>
                    </div>
                </div>
                <div class="table-with-labels">
                    <table id="tvlTradeoffTable">
                        <thead>
                            <tr>
                                <th style="text-align: left;" data-tip="Borrower equity needed to fill capacity at max leverage">Borrower Equity</th>
                                <th style="text-align: left;" data-tip="Leverage multiple: 1 / (1 - Borrow LTV)">Leverage</th>
                                <th id="netYieldHeader" style="text-align: left; overflow: visible; white-space: normal;" data-tip="Annualized yield including Twyne credit cost">Net Yield <span style="font-weight: 400; font-size: 0.7rem; text-transform: none; letter-spacing: 0; margin-left: 6px;">HF <input type="number" id="tradeoffHfInput" value="1.01" step="0.01" min="1.01" max="1.5" style="width: 46px; padding: 2px 4px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 0.7rem; text-align: center;"></span></th>
                                <th style="text-align: left;" data-tip="Total looped TVL from looper collateral + creditor deposits">Generated TVL</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="table-labels" id="tableLabels"></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; align-items: flex-start; background: rgba(156, 124, 244, 0.06); border: 1px solid rgba(156, 124, 244, 0.2); border-radius: 8px; padding: 12px 14px; margin: 0 0 20px;">
                <span style="font-size: 0.55rem; flex-shrink: 0; margin-top: 5px; color: var(--accent-purple);">&#9679;</span>
                <span style="color: var(--text-secondary); font-size: 0.8rem; line-height: 1.6;">
                    <strong style="color: var(--text-primary);">How to read</strong> <span style="font-size: 0.7rem; opacity: 0.5; margin-left: 10px;">click a row above</span><br><span id="qClpSeed" style="color: var(--text-primary); font-weight: 600;">—</span> in creditor deposits earning <span id="qClpBaseYield" style="color: var(--text-primary); font-weight: 600;">—</span> base + <span id="qClpRate" style="color: var(--text-primary); font-weight: 600;">—</span> delegation yield enables a borrower to deploy <span id="qBorrowerEquity" style="color: var(--text-primary); font-weight: 600;">—</span> at <span id="qLeverage" style="color: var(--text-primary); font-weight: 600;">—</span> leverage, netting <span id="qNetYield" style="color: var(--text-primary); font-weight: 600;">—</span> APY and generating <span id="qGeneratedTvl" style="color: var(--text-primary); font-weight: 600;">—</span> in protocol TVL.
                </span>
            </div>

            <!-- Trade-off Section -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <div style="background: rgba(74, 155, 181, 0.08); border: 1px solid rgba(74, 155, 181, 0.25); border-radius: 8px; padding: 14px 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent-blue); font-weight: 600;">Creditor</span>
                        <span style="font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; background: rgba(74, 155, 181, 0.15); color: var(--accent-blue); font-weight: 600; letter-spacing: 0.5px;">PASSIVE</span>
                    </div>
                    <ul style="margin: 0; padding-left: 16px; color: var(--text-secondary); font-size: 0.82rem; line-height: 1.8;">
                        <li>Staking + Lending + Delegation yield</li>
                        <li>No interest rate or slippage risk</li>
                        <li>Carries liquidation risk (heavily reduced with correlated assets)</li>
                    </ul>
                </div>
                <div style="background: rgba(224, 167, 50, 0.08); border: 1px solid rgba(224, 167, 50, 0.25); border-radius: 8px; padding: 14px 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent-amber); font-weight: 600;">Borrower</span>
                        <span style="font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; background: rgba(224, 167, 50, 0.15); color: var(--accent-amber); font-weight: 600; letter-spacing: 0.5px;">ACTIVE</span>
                    </div>
                    <ul style="margin: 0; padding-left: 16px; color: var(--text-secondary); font-size: 0.82rem; line-height: 1.8;">
                        <li>Higher leverage for more yield, or same leverage with less capital</li>
                        <li>Added buffer against liquidation at any leverage level</li>
                        <li>Interest rate risk (Twyne rate is marginal relative to ETH borrow cost)</li>
                    </ul>
                </div>
            </div>

            <!-- Beta Safety Impact Warning -->
            <div class="chart-container" id="betaWarningBox" style="background: linear-gradient(135deg, rgba(239, 108, 0, 0.1), rgba(239, 108, 0, 0.05)); border: 1px solid rgba(239, 108, 0, 0.3); display: none;">
                <div class="chart-title" style="color: var(--accent-orange);">⚠️ Safety Buffer Impact</div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
                    When β &lt; 1, capital efficiency drops significantly:
                </p>
                <div class="stat-display" style="background: var(--bg-secondary);">
                    <div class="stat-row">
                        <span class="stat-label">β = 1.00 (max efficiency)</span>
                        <span class="stat-value">$<span id="betaOneMultiplier">18.6</span>/creditor</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">β = <span id="currentBetaDisplay">0.95</span> (current)</span>
                        <span class="stat-value warning">$<span id="currentBetaMultiplier">5.4</span>/creditor</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Efficiency Loss</span>
                        <span class="stat-value warning" id="betaEfficiencyLoss">71% drop</span>
                    </div>
                </div>
            </div>
                </div>
            </details>

            <!-- More Analytics (single expandable) -->
            <details id="moreAnalyticsDetails" style="margin-top: 40px; background: rgba(156,124,244,0.06); border: 1px solid rgba(156,124,244,0.2); border-radius: 12px;">
                <summary style="cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; padding: 16px 20px;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.3rem;">More Analytics</h2>
                        <p class="description" style="margin: 4px 0 0;">Yield heatmaps, interest rate model, and TVL multiplier landscape.</p>
                    </div>
                    <span style="font-size: 1rem; color: var(--text-secondary); flex-shrink: 0; margin-left: 12px;">&#9662;</span>
                </summary>
                <div style="padding: 0 20px 20px;">
                    <!-- Yield & IRM -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div style="background: rgba(156,124,244,0.06); border: 1px solid rgba(156,124,244,0.15); border-radius: 10px; padding: 14px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: var(--accent-purple);">Net Looping Yield</div>
                                <div style="display: flex; gap: 10px; align-items: center; font-size: 0.75rem; color: var(--text-secondary);">
                                    <label>HF <input type="number" id="hfMin" value="1.01" step="0.01" min="1.01" max="1.5" style="width: 50px; padding: 2px 4px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 0.7rem; text-align: center;"></label>
                                    <span style="color: var(--text-secondary);">to</span>
                                    <label><input type="number" id="hfMax" value="1.05" step="0.01" min="1.02" max="2.0" style="width: 50px; padding: 2px 4px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 0.7rem; text-align: center;"></label>
                                </div>
                            </div>
                            <div id="yieldHeatmap"></div>
                        </div>
                        <div style="background: rgba(156,124,244,0.06); border: 1px solid rgba(156,124,244,0.15); border-radius: 10px; padding: 14px;">
                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--accent-purple); margin-bottom: 6px;">Interest Rate Model</div>
                            <div style="display: flex; gap: 16px; padding: 6px 10px; background: rgba(156,124,244,0.06); border-radius: 6px; margin-bottom: 8px; font-size: 0.75rem;">
                                <span>At <span id="irmUtilDisplay" style="color: var(--text-primary); font-weight: 600;">—</span> util</span>
                                <span style="color: var(--border-color);">|</span>
                                <span>Creditor Rate: <span id="irmClpRateMain" style="color: var(--accent-blue); font-weight: 600;">—</span></span>
                                <span style="color: var(--border-color);">|</span>
                                <span>Borrower Cost: <span id="irmBorrowerRateMain" style="color: var(--accent-amber); font-weight: 600;">—</span></span>
                            </div>
                            <div id="irmChartMain" style="width: 100%; height: 220px;"></div>
                        </div>
                    </div>

                    <!-- TVL Multiplier Landscape -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 1.1rem; margin: 0 0 2px;">TVL Multiplier Landscape</h3>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">How much CLP TVL each unit of borrower collateral attracts &mdash; &beta;<sub>safe</sub> = <span id="tvlHeatmapBeta">—</span></div>
                        <div id="tvlMultiplierHeatmap" style="width: 100%; height: 720px;"></div>
                    </div>

                </div>
            </details>

        </main>
    </div>

    <script>
        // =====================================================================
        // Historical Rate Data — Source: DeFi Llama yields API
        // =====================================================================
        // rsETH Staking Yield (Kelp DAO, May 2024 – Feb 2026, 632 days)
        const RSETH_YIELD_HISTORY = [2.31,2.15,2.28,2.28,2.23,2.17,2.29,2.29,2.09,2.09,1.91,1.91,2.02,2.02,1.89,1.89,1.89,1.63,2.03,2.03,2.03,1.98,1.98,1.96,1.89,1.8,2.04,2.04,2.04,2,1.93,1.93,1.8,1.8,1.93,1.93,1.81,1.81,1.89,1.89,1.94,1.94,1.79,1.79,1.79,1.93,1.93,2.02,1.57,1.67,1.67,4.44,4.27,4.16,4.28,4.28,4.12,4.03,4.03,3.93,3.93,4.38,4.38,4.46,4.23,4.23,4.74,4.74,4.56,4.56,5.16,5.16,5.07,5.18,5.18,5.23,5.23,5.26,5.26,5.17,5.52,2.75,2.95,2.95,3.05,3.05,2.96,3.09,3.09,3.5,3.5,3.2,3.2,3.13,3.5,3.5,3.29,3.29,3.54,3.54,2.88,3.05,3.05,3.17,3.17,3.09,3.09,2.96,3.04,3.04,2.92,2.92,2.94,2.94,2.73,2.98,2.98,2.96,2.96,2.74,2.74,2.85,2.89,2.89,2.9,2.9,2.91,2.91,2.59,2.7,3.35,3.8,3.8,3.63,3.63,3.53,3.67,3.67,3.71,3.71,3.65,3.65,3.97,3.93,3.93,3.74,3.88,3.61,3.67,3.67,4.03,4.03,3.71,3.86,3.86,3.79,3.14,2.55,2.55,3.18,3.21,3.21,3.16,3.16,3.13,3.13,3.07,3.07,2.76,2.56,2.62,3.16,3.16,3.13,3.13,3.26,3.16,3.16,3.13,3.13,2.4,2.95,2.99,2.88,2.88,2.91,3.12,3.15,3.22,2.58,2.59,2.67,3.01,3.05,3.01,3.06,3,3.05,3.51,3.47,3.46,2.84,2.9,2.89,2.95,2.88,2.91,2.97,2.97,3.04,3.12,2.77,2.8,3.08,3.2,3.19,3.07,3.07,3.07,3.09,3.18,3.18,2.82,2.85,2.89,2.92,3.17,3.19,2.81,2.78,2.8,2.81,2.82,3.01,3.02,3.03,3.04,3.06,3.05,3.05,3.1,3.07,3.07,2.83,2.8,2.79,2.79,2.85,2.86,2.87,2.8,2.8,2.81,2.81,2.81,2.81,2.86,2.86,2.86,2.89,2.9,2.9,2.91,2.75,2.83,2.83,2.83,2.83,2.83,3.1,3.06,3.1,3.11,3.11,3.1,3.15,3.15,3.08,3.08,3.09,3.09,3.08,3.3,3.29,3.29,3.27,3,2.99,2.99,3.1,3.1,3.13,3.13,3.13,3.08,3.08,3.17,3.19,3.21,2.95,2.94,2.8,2.8,2.88,2.88,2.89,2.91,2.91,2.92,2.9,3.13,3.13,2.9,2.9,2.9,2.9,2.9,3.03,3.02,2.88,2.88,2.85,2.85,2.84,2.9,2.96,2.87,2.89,2.87,2.87,2.86,3.03,3.14,3.06,3.07,3.03,3.02,3.02,3.17,3.17,3,2.94,2.95,2.94,2.92,3.07,3.07,2.94,2.96,2.96,2.96,2.96,3.04,3.04,3.01,2.9,2.88,2.85,2.84,3.03,3.03,2.84,2.73,2.72,2.72,2.74,2.87,2.87,2.72,2.72,2.73,2.73,2.73,2.88,2.9,2.75,2.75,2.83,2.75,2.74,2.84,2.84,2.74,2.74,2.75,2.75,2.75,2.97,2.98,2.79,2.79,2.79,2.79,2.78,2.94,2.91,2.76,2.76,2.75,2.74,2.72,2.88,2.87,2.73,2.71,2.71,2.7,2.62,2.79,2.79,2.69,2.69,2.69,2.69,2.67,2.88,2.87,2.65,2.63,2.62,2.62,2.62,2.79,2.79,2.6,2.6,2.6,2.6,2.6,2.76,2.77,2.59,2.6,2.6,2.6,2.6,2.71,2.71,2.6,2.6,2.59,2.59,2.59,2.82,2.88,2.6,2.6,2.6,2.59,2.59,2.78,2.78,2.6,2.59,2.64,2.59,2.59,2.76,2.76,2.59,2.6,2.6,2.62,2.61,2.79,2.79,2.67,2.67,2.69,2.69,2.69,2.75,2.76,2.52,2.73,2.69,2.68,2.68,2.76,2.77,2.58,2.7,2.7,2.7,2.7,2.84,2.83,2.67,2.65,2.68,2.68,2.67,2.72,2.7,2.67,2.66,2.7,2.66,2.61,2.6,2.65,2.75,2.74,2.73,2.5,2.55,2.6,2.6,2.49,2.58,2.57,2.45,2.45,2.57,2.56,2.52,2.46,2.44,2.54,2.56,2.56,2.57,2.49,2.68,2.5,2.5,2.5,2.53,2.55,2.72,2.65,2.43,2.43,2.43,2.56,2.54,2.49,2.49,2.51,2.41,2.4,2.57,2.56,2.44,2.46,2.36,2.42,2.42,2.49,2.42,2.42,2.41,2.41,2.36,2.39,2.4,2.41,3.21,2.97,2.98,2.52,2.47,2.96,2.95,2.45,2.46,2.77,2.7,2.68,2.68,2.67,2.58,2.7,2.51,2.5,2.48,2.68,2.7,2.51,2.5,2.49,2.49,2.47,2.56,2.55,2.53,2.52,2.87,3,2.88,2.44,2.44,2.88,3.14,2.46,2.46,2.27,2.54,2.5,2.5,2.48,3.11,3.21,3.08,2.42,2.51,2.51,2.5,2.67,2.67,2.52,2.52,2.46,2.45,2.34,2.52,2.55,2.52,2.52,2.83,3.04,2.91,2.52,2.52,2.53,2.54,2.61,2.36,2.4,2.43,2.48,2.34];

        // WETH Borrow Rate (Aave V3 Ethereum, May 2024 – Feb 2026, 639 days)
        const WETH_BORROW_HISTORY = [2.3,2.44,2.41,2.4,2.39,2.37,2.4,2.4,2.55,2.51,2.51,2.51,2.52,2.45,2.39,2.38,2.23,2.28,2.29,2.28,2.24,2.24,2.28,2.31,2.32,2.31,2.32,2.41,2.52,2.49,2.49,2.49,2.48,2.47,2.5,2.51,2.5,2.46,2.47,2.5,2.49,2.5,2.51,2.56,2.68,2.58,2.56,2.48,2.42,2.5,2.58,4.23,2.7,2.69,2.68,2.62,2.62,3.11,7.34,4.73,2.69,2.69,2.68,2.69,2.69,2.66,2.68,2.68,2.67,2.58,2.58,2.56,2.58,2.57,2.47,2.52,2.53,2.7,2.7,2.69,2.67,2.68,2.67,2.67,2.66,2.63,2.64,2.63,2.6,2.61,2.61,2.58,2.55,2.54,2.59,2.62,2.69,2.69,2.62,2.58,2.57,2.58,2.58,2.54,2.54,2.5,2.48,2.46,2.44,2.43,2.5,2.53,2.53,2.58,2.56,2.56,2.55,2.55,2.55,2.57,2.63,2.63,2.67,2.63,2.61,2.56,2.57,2.56,2.55,2.55,2.59,2.61,2.69,2.68,3.31,2.64,2.55,2.56,2.57,2.6,2.6,2.62,2.7,2.69,2.66,2.65,2.67,5.29,2.7,2.7,2.97,2.68,2.65,2.7,2.69,5.85,2.65,2.7,2.69,2.7,3.1,2.68,2.69,2.67,2.69,2.69,2.68,2.6,2.7,2.69,2.68,2.67,2.66,2.69,2.66,2.7,2.64,2.68,2.62,2.68,2.63,2.62,2.63,2.64,2.63,2.65,2.64,2.68,2.67,2.64,2.65,2.62,2.65,2.61,2.64,2.63,2.57,2.63,2.62,2.59,2.56,2.55,2.51,2.49,2.66,2.67,2.68,2.67,2.67,2.67,2.69,2.7,3.09,2.68,2.7,2.68,2.66,2.7,2.73,3.81,2.7,3.64,2.69,2.7,2.67,2.66,2.64,2.7,3.85,7.59,2.7,2.55,2.53,2.54,2.58,2.6,2.59,2.59,2.57,2.55,2.59,2.57,2.6,2.6,2.56,2.58,2.59,2.57,2.55,2.55,2.41,2.4,2.43,2.43,2.44,2.51,2.5,2.52,2.53,2.57,2.58,2.66,2.64,2.64,2.61,2.56,2.61,2.64,2.67,2.67,2.67,2.65,2.7,3.19,2.66,2.65,2.63,2.65,2.62,2.61,2.56,2.51,2.48,2.5,2.52,2.51,2.51,2.49,2.51,2.51,2.59,2.65,2.64,2.64,2.56,2.55,2.55,2.58,2.6,2.61,2.62,2.61,2.59,2.55,2.56,2.61,2.62,2.7,2.7,2.69,2.69,2.7,2.7,6.18,2.7,2.82,2.61,2.62,2.6,2.68,2.69,2.68,2.65,2.63,2.62,2.63,2.63,2.63,2.67,2.65,2.65,2.64,2.62,2.62,2.66,2.69,3.82,2.68,2.65,2.69,2.7,2.68,2.7,2.7,2.66,2.66,2.66,2.67,2.67,2.65,2.63,2.65,2.67,2.65,2.67,2.64,2.62,2.6,2.58,2.57,2.55,2.53,2.57,2.54,2.56,2.53,2.66,2.57,2.57,2.56,2.56,2.54,2.6,2.59,2.56,2.54,2.54,2.53,2.52,2.56,2.44,2.46,2.44,2.43,2.42,2.43,2.51,2.6,2.61,2.62,2.61,2.59,2.57,2.56,2.59,2.58,2.59,2.58,2.59,2.59,2.62,2.58,2.59,2.59,2.6,2.6,2.6,2.59,2.59,2.59,2.6,2.56,2.55,2.57,2.52,2.52,2.52,2.51,2.51,2.51,2.51,2.51,2.49,2.58,2.58,2.57,2.58,2.59,2.59,2.62,2.69,2.69,2.68,5.34,6.95,2.67,7.24,6.58,2.66,6.58,4.24,4.36,3.0,2.97,2.97,2.99,2.89,2.9,2.95,3.04,2.89,2.89,4.25,3.09,2.88,2.84,2.82,2.77,2.69,2.64,2.65,2.49,2.52,2.57,2.66,2.66,2.66,2.66,2.66,4.01,2.65,2.61,2.6,2.62,2.63,2.61,2.61,2.61,2.65,2.65,2.66,2.64,2.63,2.64,2.62,2.6,2.59,2.58,2.59,2.59,2.57,2.54,2.49,2.48,2.47,2.47,2.45,2.35,2.32,2.28,2.24,2.24,2.24,2.31,2.32,2.3,2.34,2.28,2.29,2.25,2.26,2.25,2.3,2.3,2.31,2.31,2.39,2.39,2.38,2.41,2.35,2.35,2.38,2.42,2.4,2.4,2.4,2.4,2.45,2.44,2.46,2.53,2.54,2.53,2.52,2.52,2.49,2.47,2.45,2.44,2.44,2.46,2.46,2.47,2.46,2.46,2.48,2.49,2.52,2.45,2.49,2.48,2.36,2.27,2.2,2.08,2.02,2.15,2.07,2.07,2.09,2.09,2.04,2.02,2.03,2.01,2.01,1.95,1.97,1.98,1.99,1.92,1.93,1.85,1.83,1.85,1.84,1.83,1.83,1.83,1.86,1.9,1.95,1.98,1.97,1.97,1.94,1.96,1.96,1.95,1.96,2.03,2.03,2.04,2.04,2.03,2.01,2.0,2.01,2.01,2.0,1.96,1.97,1.98,1.96,1.97,1.98,1.98,1.98,1.99,2.0,2.0,2.02,2.03,2.03,2.03,2.04,2.04,2.07,2.06,1.94,1.94,1.95,2.02,2.09,2.12,2.14,2.13,2.13,2.06,2.11,2.14,2.2,2.19,2.22,2.19,2.23,2.28,2.3];


        // stETH Staking Yield (Lido, May 2024 – Feb 2026, approximate — same length as rsETH)
        // Source: Approximate based on Lido published staking APR
        const STETH_YIELD_HISTORY = (() => {
            const len = RSETH_YIELD_HISTORY.length;
            const arr = new Array(len);
            for (let i = 0; i < len; i++) {
                // stETH yield: ~3.3% early 2024, gradually declining to ~3.0% by late 2025
                const trend = 3.30 - 0.30 * (i / len);
                const noise = Math.sin(i * 0.13) * 0.06 + Math.cos(i * 0.07) * 0.04;
                arr[i] = +(trend + noise).toFixed(2);
            }
            return arr;
        })();

        // rsETH-ETH Historical APR data (May 2024 – Feb 2026, 632 days)
        // Source: DeFi Llama (rsETH Kelp DAO + WETH Aave V3)

        // eETH-ETH Historical APR data (Jun 2024 – Feb 2026, 610 days)
        // Source: DeFi Llama (eETH ether.fi + WETH Aave V3)
        const EETH_HIST_DATES = ["2024-06-05", "2024-06-06", "2024-06-07", "2024-06-08", "2024-06-09", "2024-06-10", "2024-06-11", "2024-06-12", "2024-06-13", "2024-06-14", "2024-06-15", "2024-06-16", "2024-06-17", "2024-06-18", "2024-06-19", "2024-06-20", "2024-06-21", "2024-06-22", "2024-06-23", "2024-06-24", "2024-06-25", "2024-06-26", "2024-06-27", "2024-06-28", "2024-06-29", "2024-06-30", "2024-07-01", "2024-07-02", "2024-07-03", "2024-07-04", "2024-07-05", "2024-07-06", "2024-07-07", "2024-07-08", "2024-07-09", "2024-07-10", "2024-07-11", "2024-07-12", "2024-07-13", "2024-07-14", "2024-07-15", "2024-07-16", "2024-07-17", "2024-07-18", "2024-07-19", "2024-07-20", "2024-07-21", "2024-07-22", "2024-07-23", "2024-07-24", "2024-07-25", "2024-07-26", "2024-07-27", "2024-07-28", "2024-07-29", "2024-07-30", "2024-07-31", "2024-08-01", "2024-08-02", "2024-08-03", "2024-08-04", "2024-08-05", "2024-08-06", "2024-08-07", "2024-08-08", "2024-08-09", "2024-08-10", "2024-08-11", "2024-08-12", "2024-08-13", "2024-08-14", "2024-08-15", "2024-08-16", "2024-08-17", "2024-08-18", "2024-08-19", "2024-08-20", "2024-08-21", "2024-08-22", "2024-08-23", "2024-08-24", "2024-08-25", "2024-08-26", "2024-08-27", "2024-08-28", "2024-08-29", "2024-08-30", "2024-08-31", "2024-09-01", "2024-09-02", "2024-09-03", "2024-09-04", "2024-09-05", "2024-09-06", "2024-09-07", "2024-09-08", "2024-09-09", "2024-09-10", "2024-09-11", "2024-09-12", "2024-09-13", "2024-09-14", "2024-09-15", "2024-09-16", "2024-09-17", "2024-09-18", "2024-09-19", "2024-09-20", "2024-09-21", "2024-09-22", "2024-09-23", "2024-09-24", "2024-09-25", "2024-09-26", "2024-09-27", "2024-09-28", "2024-09-29", "2024-09-30", "2024-10-01", "2024-10-02", "2024-10-03", "2024-10-04", "2024-10-05", "2024-10-06", "2024-10-07", "2024-10-08", "2024-10-09", "2024-10-10", "2024-10-11", "2024-10-12", "2024-10-13", "2024-10-14", "2024-10-15", "2024-10-16", "2024-10-17", "2024-10-18", "2024-10-19", "2024-10-20", "2024-10-21", "2024-10-22", "2024-10-23", "2024-10-24", "2024-10-25", "2024-10-26", "2024-10-27", "2024-10-28", "2024-10-29", "2024-10-30", "2024-10-31", "2024-11-01", "2024-11-02", "2024-11-03", "2024-11-04", "2024-11-05", "2024-11-06", "2024-11-07", "2024-11-08", "2024-11-09", "2024-11-10", "2024-11-11", "2024-11-12", "2024-11-13", "2024-11-14", "2024-11-15", "2024-11-16", "2024-11-17", "2024-11-18", "2024-11-19", "2024-11-20", "2024-11-21", "2024-11-22", "2024-11-23", "2024-11-24", "2024-11-25", "2024-11-26", "2024-11-27", "2024-11-28", "2024-11-29", "2024-11-30", "2024-12-01", "2024-12-02", "2024-12-03", "2024-12-04", "2024-12-05", "2024-12-06", "2024-12-07", "2024-12-08", "2024-12-09", "2024-12-10", "2024-12-11", "2024-12-12", "2024-12-13", "2024-12-14", "2024-12-15", "2024-12-16", "2024-12-17", "2024-12-18", "2024-12-19", "2024-12-20", "2024-12-21", "2024-12-22", "2024-12-23", "2024-12-24", "2024-12-25", "2024-12-26", "2024-12-27", "2024-12-28", "2024-12-29", "2024-12-30", "2024-12-31", "2025-01-01", "2025-01-02", "2025-01-03", "2025-01-04", "2025-01-05", "2025-01-06", "2025-01-07", "2025-01-08", "2025-01-09", "2025-01-10", "2025-01-11", "2025-01-12", "2025-01-13", "2025-01-14", "2025-01-15", "2025-01-16", "2025-01-17", "2025-01-18", "2025-01-19", "2025-01-20", "2025-01-21", "2025-01-22", "2025-01-23", "2025-01-24", "2025-01-25", "2025-01-26", "2025-01-27", "2025-01-28", "2025-01-29", "2025-01-30", "2025-01-31", "2025-02-01", "2025-02-02", "2025-02-03", "2025-02-04", "2025-02-05", "2025-02-06", "2025-02-07", "2025-02-08", "2025-02-09", "2025-02-10", "2025-02-11", "2025-02-12", "2025-02-13", "2025-02-14", "2025-02-15", "2025-02-16", "2025-02-17", "2025-02-18", "2025-02-19", "2025-02-20", "2025-02-21", "2025-02-22", "2025-02-23", "2025-02-24", "2025-02-25", "2025-02-26", "2025-02-27", "2025-02-28", "2025-03-01", "2025-03-02", "2025-03-03", "2025-03-04", "2025-03-05", "2025-03-06", "2025-03-07", "2025-03-08", "2025-03-09", "2025-03-10", "2025-03-11", "2025-03-12", "2025-03-13", "2025-03-14", "2025-03-15", "2025-03-16", "2025-03-17", "2025-03-18", "2025-03-19", "2025-03-20", "2025-03-21", "2025-03-22", "2025-03-23", "2025-03-24", "2025-03-25", "2025-03-26", "2025-03-27", "2025-03-28", "2025-03-29", "2025-03-30", "2025-03-31", "2025-04-01", "2025-04-02", "2025-04-03", "2025-04-04", "2025-04-05", "2025-04-06", "2025-04-07", "2025-04-08", "2025-04-09", "2025-04-10", "2025-04-11", "2025-04-12", "2025-04-13", "2025-04-14", "2025-04-15", "2025-04-16", "2025-04-17", "2025-04-18", "2025-04-19", "2025-04-20", "2025-04-21", "2025-04-22", "2025-04-23", "2025-04-24", "2025-04-25", "2025-04-26", "2025-04-27", "2025-04-28", "2025-04-29", "2025-04-30", "2025-05-01", "2025-05-02", "2025-05-03", "2025-05-04", "2025-05-05", "2025-05-06", "2025-05-07", "2025-05-08", "2025-05-09", "2025-05-10", "2025-05-11", "2025-05-12", "2025-05-13", "2025-05-14", "2025-05-15", "2025-05-16", "2025-05-17", "2025-05-18", "2025-05-19", "2025-05-20", "2025-05-21", "2025-05-22", "2025-05-23", "2025-05-24", "2025-05-25", "2025-05-26", "2025-05-27", "2025-05-28", "2025-05-29", "2025-05-30", "2025-05-31", "2025-06-01", "2025-06-02", "2025-06-03", "2025-06-04", "2025-06-05", "2025-06-06", "2025-06-07", "2025-06-08", "2025-06-09", "2025-06-10", "2025-06-11", "2025-06-12", "2025-06-13", "2025-06-14", "2025-06-15", "2025-06-16", "2025-06-17", "2025-06-18", "2025-06-19", "2025-06-20", "2025-06-21", "2025-06-22", "2025-06-23", "2025-06-24", "2025-06-25", "2025-06-26", "2025-06-27", "2025-06-28", "2025-06-29", "2025-06-30", "2025-07-01", "2025-07-02", "2025-07-03", "2025-07-04", "2025-07-05", "2025-07-06", "2025-07-07", "2025-07-08", "2025-07-09", "2025-07-10", "2025-07-11", "2025-07-12", "2025-07-13", "2025-07-14", "2025-07-15", "2025-07-16", "2025-07-17", "2025-07-18", "2025-07-19", "2025-07-20", "2025-07-21", "2025-07-22", "2025-07-23", "2025-07-24", "2025-07-25", "2025-07-26", "2025-07-27", "2025-07-28", "2025-07-29", "2025-07-30", "2025-07-31", "2025-08-01", "2025-08-02", "2025-08-03", "2025-08-04", "2025-08-05", "2025-08-06", "2025-08-07", "2025-08-08", "2025-08-09", "2025-08-10", "2025-08-11", "2025-08-12", "2025-08-13", "2025-08-14", "2025-08-15", "2025-08-16", "2025-08-17", "2025-08-18", "2025-08-19", "2025-08-20", "2025-08-21", "2025-08-22", "2025-08-23", "2025-08-24", "2025-08-25", "2025-08-26", "2025-08-27", "2025-08-28", "2025-08-29", "2025-08-30", "2025-08-31", "2025-09-01", "2025-09-02", "2025-09-03", "2025-09-04", "2025-09-05", "2025-09-06", "2025-09-07", "2025-09-08", "2025-09-09", "2025-09-10", "2025-09-11", "2025-09-12", "2025-09-13", "2025-09-14", "2025-09-15", "2025-09-16", "2025-09-17", "2025-09-18", "2025-09-19", "2025-09-20", "2025-09-21", "2025-09-22", "2025-09-23", "2025-09-24", "2025-09-25", "2025-09-26", "2025-09-27", "2025-09-28", "2025-09-29", "2025-09-30", "2025-10-01", "2025-10-02", "2025-10-03", "2025-10-04", "2025-10-05", "2025-10-06", "2025-10-07", "2025-10-08", "2025-10-09", "2025-10-10", "2025-10-11", "2025-10-12", "2025-10-13", "2025-10-14", "2025-10-15", "2025-10-16", "2025-10-17", "2025-10-18", "2025-10-19", "2025-10-20", "2025-10-21", "2025-10-22", "2025-10-23", "2025-10-24", "2025-10-25", "2025-10-26", "2025-10-27", "2025-10-28", "2025-10-29", "2025-10-30", "2025-10-31", "2025-11-01", "2025-11-02", "2025-11-03", "2025-11-04", "2025-11-05", "2025-11-06", "2025-11-07", "2025-11-08", "2025-11-09", "2025-11-10", "2025-11-11", "2025-11-12", "2025-11-13", "2025-11-14", "2025-11-15", "2025-11-16", "2025-11-17", "2025-11-18", "2025-11-19", "2025-11-20", "2025-11-21", "2025-11-22", "2025-11-23", "2025-11-24", "2025-11-25", "2025-11-26", "2025-11-27", "2025-11-28", "2025-11-29", "2025-11-30", "2025-12-01", "2025-12-02", "2025-12-03", "2025-12-04", "2025-12-05", "2025-12-06", "2025-12-07", "2025-12-08", "2025-12-09", "2025-12-10", "2025-12-11", "2025-12-12", "2025-12-13", "2025-12-14", "2025-12-15", "2025-12-16", "2025-12-17", "2025-12-18", "2025-12-19", "2025-12-20", "2025-12-21", "2025-12-22", "2025-12-23", "2025-12-24", "2025-12-25", "2025-12-26", "2025-12-27", "2025-12-28", "2025-12-29", "2025-12-30", "2025-12-31", "2026-01-01", "2026-01-02", "2026-01-03", "2026-01-04", "2026-01-05", "2026-01-06", "2026-01-07", "2026-01-08", "2026-01-09", "2026-01-10", "2026-01-11", "2026-01-12", "2026-01-13", "2026-01-14", "2026-01-15", "2026-01-16", "2026-01-17", "2026-01-18", "2026-01-19", "2026-01-20", "2026-01-21", "2026-01-22", "2026-01-23", "2026-01-24", "2026-01-25", "2026-01-26", "2026-01-27", "2026-01-28", "2026-01-29", "2026-01-30", "2026-01-31", "2026-02-01", "2026-02-02", "2026-02-03", "2026-02-04"];
        const EETH_HIST_R_STAKE = [3.49, 2.07, 2.99, 2.25, 3.15, 2.61, 3.0, 2.66, 2.45, 2.94, 1.75, 3.59, 2.37, 2.93, 3.09, 2.51, 2.26, 2.72, 3.09, 2.45, 3.09, 1.92, 3.72, 2.34, 2.46, 2.46, 2.6, 2.64, 4.07, 2.68, 2.81, 2.64, 2.32, 2.73, 3.08, 2.78, 2.81, 4.05, 2.45, 2.57, 3.35, 2.24, 2.73, 2.76, 2.75, 4.09, 2.88, 2.85, 2.7, 1.34, 5.3, 3.91, 2.21, 2.5, 2.33, 3.45, 2.01, 3.71, 2.05, 2.64, 2.52, 3.11, 3.23, 3.37, 4.07, 4.81, 2.98, 4.91, 4.35, 3.47, 3.67, 2.8, 2.95, 2.99, 2.9, 2.59, 2.67, 2.66, 1.7, 3.31, 0, 2.91, 2.87, 2.63, 2.83, 2.51, 2.75, 2.62, 2.59, 2.7, 2.95, 2.7, 3.11, 2.87, 2.79, 2.65, 2.84, 2.66, 2.86, 2.71, 2.72, 2.81, 3.01, 3.35, 2.43, 2.52, 3.01, 3.16, 3.25, 2.99, 3.49, 3.06, 2.92, 2.88, 2.35, 3.4, 2.28, 2.93, 2.85, 2.79, 3.03, 3.12, 2.39, 2.97, 3.13, 1.62, 3.99, 3.74, 2.92, 0.81, 4.77, 1.95, 4.17, 2.85, 2.91, 2.88, 2.52, 2.94, 2.41, 2.7, 3.11, 2.74, 2.83, 2.68, 2.56, 2.64, 2.7, 2.83, 0.75, 4.85, 3.01, 2.15, 2.79, 3.0, 3.17, 3.04, 3.01, 3.05, 2.86, 3.07, 3.3, 3.87, 3.42, 3.18, 3.04, 0.86, 4.8, 3.61, 3.18, 3.24, 3.47, 3.99, 3.38, 3.62, 3.27, 3.6, 3.42, 3.09, 3.15, 2.74, 3.49, 3.81, 4.23, 4.26, 4.84, 4.29, 4.52, 4.8, 4.43, 4.19, 4.17, 4.09, 3.86, 4.29, 4.21, 4.31, 4.13, 3.05, 4.45, 3.94, 3.75, 3.79, 3.81, 3.71, 3.52, 3.78, 3.68, 3.58, 3.88, 3.9, 3.85, 3.96, 3.81, 3.92, 3.88, 3.85, 4.06, 4.0, 3.69, 3.88, 3.11, 3.85, 4.0, 3.73, 1.0, 6.63, 2.37, 5.05, 3.67, 4.53, 0.83, 1.02, 3.48, 4.01, 3.43, 3.41, 3.34, 3.87, 4.08, 3.8, 3.98, 3.38, 2.77, 6.05, 6.02, 4.13, 2.69, 3.87, 3.42, 3.48, 3.38, 3.27, 3.33, 3.54, 3.54, 3.43, 3.43, 2.82, 3.67, 3.52, 3.76, 3.44, 4.21, 2.86, 3.97, 3.82, 4.24, 3.79, 4.35, 3.59, 2.74, 3.99, 4.89, 3.06, 2.94, 4.05, 3.59, 2.91, 4.51, 2.92, 5.7, 3.44, 3.46, 3.51, 3.39, 3.37, 3.69, 2.85, 3.89, 3.17, 2.72, 3.48, 3.2, 3.15, 1.73, 4.58, 3.52, 3.44, 2.67, 3.43, 3.75, 3.1, 3.79, 3.86, 3.62, 2.48, 6.42, 4.48, 4.63, 4.49, 3.84, 3.54, 3.83, 2.78, 3.74, 3.34, 4.17, 1.07, 5.88, 3.69, 3.47, 3.81, 4.06, 2.94, 4.0, 4.15, 3.81, 2.7, 3.85, 3.84, 3.81, 2.96, 3.31, 3.6, 2.59, 3.37, 1.99, 3.86, 3.87, 2.86, 3.15, 3.48, 3.11, 3.72, 3.46, 3.48, 3.2, 2.74, 3.03, 3.36, 3.95, 3.57, 3.03, 3.81, 3.07, 2.58, 3.5, 3.82, 3.23, 3.7, 3.3, 2.65, 3.48, 3.4, 3.44, 2.55, 3.52, 3.58, 0.53, 5.59, 3.42, 3.64, 2.8, 4.04, 2.95, 2.67, 3.36, 3.76, 2.65, 3.42, 3.28, 3.42, 2.7, 3.84, 3.49, 3.43, 2.99, 3.13, 1.88, 2.8, 2.91, 2.96, 3.2, 1.05, 3.96, 2.67, 2.88, 2.08, 2.83, 2.96, 3.07, 2.96, 2.4, 2.59, 3.08, 2.99, 2.96, 3.86, 2.59, 3.42, 3.4, 3.26, 2.86, 3.46, 2.48, 3.23, 3.78, 2.18, 3.62, 3.27, 1.98, 3.37, 3.31, 3.13, 3.43, 2.15, 3.09, 3.17, 2.11, 3.84, 2.98, 3.1, 3.12, 3.26, 2.57, 3.34, 3.55, 3.14, 3.13, 2.43, 2.15, 3.24, 3.19, 3.31, 3.7, 2.11, 3.27, 3.21, 3.12, 2.23, 3.64, 3.15, 3.4, 2.25, 3.27, 3.11, 3.15, 3.27, 2.42, 3.11, 3.08, 3.22, 3.19, 3.55, 2.17, 3.28, 3.15, 3.14, 3.49, 2.23, 3.32, 3.35, 3.23, 3.19, 2.52, 3.28, 3.28, 3.32, 3.34, 3.45, 2.51, 3.75, 2.44, 3.27, 3.23, 3.32, 3.34, 3.59, 2.23, 3.66, 3.24, 3.29, 3.56, 3.17, 4.51, 3.24, 3.3, 3.34, 2.46, 3.26, 3.23, 3.08, 3.2, 3.41, 2.38, 3.11, 3.14, 3.11, 3.33, 2.13, 3.07, 3.18, 3.08, 3.17, 2.28, 3.0, 3.19, 3.26, 3.49, 3.39, 2.18, 3.2, 3.09, 3.11, 3.44, 2.11, 3.13, 3.33, 3.55, 3.32, 2.34, 3.41, 3.1, 3.4, 0.24, 3.14, 1.6, 2.74, 2.25, 3.36, 3.38, 3.41, 3.34, 2.33, 3.22, 3.12, 3.17, 2.83, 3.23, 2.14, 2.98, 3.05, 3.49, 2.01, 2.8, 2.94, 2.89, 2.87, 2.2, 2.96, 2.83, 1.51, 3.9, 2.82, 2.79, 2.77, 2.63, 2.62, 2.79, 2.79, 2.21, 2.84, 2.87, 2.83, 2.55, 2.9, 2.81, 2.86, 2.14, 2.82, 2.91, 1.27, 4.29, 3.07, 1.8, 2.68, 2.49, 2.78, 2.72, 1.75, 3.55, 2.93, 2.39, 3.32, 3.15, 2.11, 3.12, 3.04, 2.94, 2.78, 2.99, 3.04, 2.05, 2.99, 2.99, 3.06, 3.55, 2.51, 3.0, 2.97];
        const EETH_HIST_R_BORROW = [2.49, 2.49, 2.49, 2.48, 2.47, 2.5, 2.51, 2.5, 2.46, 2.47, 2.5, 2.49, 2.5, 2.51, 2.56, 2.68, 2.58, 2.56, 2.48, 2.42, 2.5, 2.58, 4.23, 2.7, 2.69, 2.68, 2.62, 2.62, 3.11, 7.34, 4.73, 2.69, 2.69, 2.68, 2.69, 2.69, 2.66, 2.68, 2.68, 2.67, 2.58, 2.58, 2.56, 2.58, 2.57, 2.47, 2.52, 2.53, 2.7, 2.7, 2.69, 2.67, 2.68, 2.67, 2.67, 2.66, 2.63, 2.64, 2.63, 2.6, 2.61, 2.61, 2.58, 2.55, 2.54, 2.59, 2.62, 2.69, 2.69, 2.62, 2.58, 2.57, 2.58, 2.58, 2.54, 2.54, 2.5, 2.48, 2.46, 2.44, 2.43, 2.5, 2.53, 2.53, 2.58, 2.56, 2.56, 2.55, 2.55, 2.55, 2.57, 2.63, 2.63, 2.67, 2.63, 2.61, 2.56, 2.57, 2.56, 2.55, 2.55, 2.59, 2.61, 2.69, 2.68, 3.31, 2.64, 2.55, 2.56, 2.57, 2.6, 2.6, 2.62, 2.7, 2.69, 2.66, 2.65, 2.67, 5.29, 2.7, 2.7, 2.97, 2.68, 2.65, 2.7, 2.69, 5.85, 2.65, 2.7, 2.69, 2.7, 3.1, 2.68, 2.69, 2.67, 2.69, 2.69, 2.68, 2.6, 2.7, 2.69, 2.68, 2.67, 2.66, 2.69, 2.66, 2.7, 2.64, 2.68, 2.62, 2.68, 2.63, 2.62, 2.63, 2.64, 2.63, 2.65, 2.64, 2.68, 2.67, 2.64, 2.65, 2.62, 2.65, 2.61, 2.64, 2.63, 2.57, 2.63, 2.62, 2.59, 2.56, 2.55, 2.51, 2.49, 2.66, 2.67, 2.68, 2.67, 2.67, 2.67, 2.69, 2.7, 3.09, 2.68, 2.7, 2.68, 2.66, 2.7, 2.73, 3.81, 2.7, 3.64, 2.69, 2.7, 2.67, 2.66, 2.64, 2.7, 3.85, 7.59, 2.7, 2.55, 2.53, 2.54, 2.58, 2.6, 2.59, 2.59, 2.57, 2.55, 2.59, 2.57, 2.6, 2.6, 2.56, 2.58, 2.59, 2.57, 2.55, 2.55, 2.41, 2.4, 2.43, 2.43, 2.44, 2.51, 2.5, 2.52, 2.53, 2.57, 2.58, 2.66, 2.64, 2.64, 2.61, 2.56, 2.61, 2.64, 2.67, 2.67, 2.67, 2.65, 2.7, 3.19, 2.66, 2.65, 2.63, 2.65, 2.62, 2.61, 2.56, 2.51, 2.48, 2.5, 2.52, 2.51, 2.51, 2.49, 2.51, 2.51, 2.59, 2.65, 2.64, 2.64, 2.56, 2.55, 2.55, 2.58, 2.6, 2.61, 2.62, 2.61, 2.59, 2.55, 2.56, 2.61, 2.62, 2.7, 2.7, 2.69, 2.69, 2.7, 2.7, 6.18, 2.7, 2.82, 2.61, 2.62, 2.6, 2.68, 2.69, 2.68, 2.65, 2.63, 2.62, 2.63, 2.63, 2.63, 2.67, 2.65, 2.65, 2.64, 2.62, 2.62, 2.66, 2.69, 3.82, 2.68, 2.65, 2.69, 2.7, 2.68, 2.7, 2.7, 2.66, 2.66, 2.66, 2.67, 2.67, 2.65, 2.63, 2.65, 2.67, 2.65, 2.67, 2.64, 2.62, 2.6, 2.58, 2.57, 2.55, 2.53, 2.57, 2.54, 2.56, 2.53, 2.66, 2.57, 2.57, 2.56, 2.56, 2.54, 2.6, 2.59, 2.56, 2.54, 2.54, 2.53, 2.52, 2.56, 2.44, 2.46, 2.44, 2.43, 2.42, 2.43, 2.51, 2.6, 2.61, 2.62, 2.61, 2.59, 2.57, 2.56, 2.59, 2.58, 2.59, 2.58, 2.59, 2.59, 2.62, 2.58, 2.59, 2.59, 2.6, 2.6, 2.6, 2.59, 2.59, 2.59, 2.6, 2.56, 2.55, 2.57, 2.52, 2.52, 2.52, 2.51, 2.51, 2.51, 2.51, 2.51, 2.49, 2.58, 2.58, 2.57, 2.58, 2.59, 2.59, 2.62, 2.69, 2.69, 2.68, 5.34, 6.95, 2.67, 7.24, 6.58, 2.66, 6.58, 4.24, 4.36, 3.0, 2.97, 2.97, 2.99, 2.89, 2.9, 2.95, 3.04, 2.89, 2.89, 4.25, 3.09, 2.88, 2.84, 2.82, 2.77, 2.69, 2.64, 2.65, 2.49, 2.52, 2.57, 2.66, 2.66, 2.66, 2.66, 2.66, 4.01, 2.65, 2.61, 2.6, 2.62, 2.63, 2.61, 2.61, 2.61, 2.65, 2.65, 2.66, 2.64, 2.63, 2.64, 2.62, 2.6, 2.59, 2.58, 2.59, 2.59, 2.57, 2.54, 2.49, 2.48, 2.47, 2.47, 2.45, 2.35, 2.32, 2.28, 2.24, 2.24, 2.24, 2.31, 2.32, 2.3, 2.34, 2.28, 2.29, 2.25, 2.26, 2.25, 2.3, 2.3, 2.31, 2.31, 2.39, 2.39, 2.38, 2.41, 2.35, 2.35, 2.38, 2.42, 2.4, 2.4, 2.4, 2.4, 2.45, 2.44, 2.46, 2.53, 2.54, 2.53, 2.52, 2.52, 2.49, 2.47, 2.45, 2.44, 2.44, 2.46, 2.46, 2.47, 2.46, 2.46, 2.48, 2.49, 2.52, 2.45, 2.49, 2.48, 2.36, 2.27, 2.2, 2.08, 2.02, 2.15, 2.07, 2.07, 2.09, 2.09, 2.04, 2.02, 2.03, 2.01, 2.01, 1.95, 1.97, 1.98, 1.99, 1.92, 1.93, 1.85, 1.83, 1.85, 1.84, 1.83, 1.83, 1.83, 1.86, 1.9, 1.95, 1.98, 1.97, 1.97, 1.94, 1.96, 1.96, 1.95, 1.96, 2.03, 2.03, 2.04, 2.04, 2.03, 2.01, 2.0, 2.01, 2.01, 2.0, 1.96, 1.97, 1.98, 1.96, 1.97, 1.98, 1.98, 1.98, 1.99, 2.0, 2.0, 2.02, 2.03, 2.03, 2.03, 2.04, 2.04, 2.07, 2.06, 1.94, 1.94, 1.95, 2.02, 2.09, 2.12, 2.14, 2.13, 2.13, 2.06, 2.11, 2.14, 2.2, 2.19, 2.22, 2.19, 2.23, 2.28, 2.3];
        const HIST_DATES = ["2024-05-07", "2024-05-08", "2024-05-09", "2024-05-10", "2024-05-11", "2024-05-12", "2024-05-13", "2024-05-14", "2024-05-15", "2024-05-16", "2024-05-17", "2024-05-18", "2024-05-19", "2024-05-20", "2024-05-21", "2024-05-22", "2024-05-23", "2024-05-24", "2024-05-25", "2024-05-26", "2024-05-27", "2024-05-28", "2024-05-29", "2024-05-30", "2024-05-31", "2024-06-01", "2024-06-02", "2024-06-03", "2024-06-04", "2024-06-05", "2024-06-06", "2024-06-07", "2024-06-08", "2024-06-09", "2024-06-10", "2024-06-11", "2024-06-12", "2024-06-13", "2024-06-14", "2024-06-15", "2024-06-16", "2024-06-17", "2024-06-18", "2024-06-19", "2024-06-20", "2024-06-21", "2024-06-22", "2024-06-23", "2024-06-24", "2024-06-25", "2024-06-26", "2024-06-27", "2024-06-28", "2024-06-29", "2024-06-30", "2024-07-01", "2024-07-02", "2024-07-03", "2024-07-04", "2024-07-05", "2024-07-06", "2024-07-07", "2024-07-08", "2024-07-09", "2024-07-10", "2024-07-11", "2024-07-12", "2024-07-13", "2024-07-14", "2024-07-15", "2024-07-16", "2024-07-17", "2024-07-18", "2024-07-19", "2024-07-20", "2024-07-21", "2024-07-22", "2024-07-23", "2024-07-24", "2024-07-25", "2024-07-26", "2024-07-27", "2024-07-28", "2024-07-29", "2024-07-30", "2024-07-31", "2024-08-01", "2024-08-02", "2024-08-03", "2024-08-04", "2024-08-05", "2024-08-06", "2024-08-07", "2024-08-08", "2024-08-09", "2024-08-10", "2024-08-11", "2024-08-12", "2024-08-13", "2024-08-14", "2024-08-15", "2024-08-16", "2024-08-17", "2024-08-18", "2024-08-19", "2024-08-20", "2024-08-21", "2024-08-22", "2024-08-23", "2024-08-24", "2024-08-25", "2024-08-26", "2024-08-27", "2024-08-28", "2024-08-29", "2024-08-30", "2024-08-31", "2024-09-01", "2024-09-02", "2024-09-03", "2024-09-04", "2024-09-05", "2024-09-06", "2024-09-07", "2024-09-08", "2024-09-09", "2024-09-10", "2024-09-11", "2024-09-12", "2024-09-13", "2024-09-14", "2024-09-15", "2024-09-16", "2024-09-17", "2024-09-18", "2024-09-19", "2024-09-20", "2024-09-21", "2024-09-22", "2024-09-23", "2024-09-24", "2024-09-25", "2024-09-30", "2024-10-01", "2024-10-02", "2024-10-03", "2024-10-04", "2024-10-05", "2024-10-06", "2024-10-07", "2024-10-08", "2024-10-09", "2024-10-10", "2024-10-11", "2024-10-12", "2024-10-13", "2024-10-14", "2024-10-15", "2024-10-16", "2024-10-17", "2024-10-18", "2024-10-19", "2024-10-20", "2024-10-21", "2024-10-22", "2024-10-23", "2024-10-24", "2024-10-25", "2024-10-26", "2024-10-27", "2024-10-28", "2024-10-29", "2024-10-30", "2024-10-31", "2024-11-01", "2024-11-02", "2024-11-03", "2024-11-04", "2024-11-05", "2024-11-06", "2024-11-07", "2024-11-08", "2024-11-09", "2024-11-10", "2024-11-11", "2024-11-12", "2024-11-13", "2024-11-14", "2024-11-15", "2024-11-16", "2024-11-17", "2024-11-18", "2024-11-19", "2024-11-20", "2024-11-21", "2024-11-22", "2024-11-23", "2024-11-24", "2024-11-25", "2024-11-26", "2024-11-27", "2024-11-28", "2024-11-29", "2024-11-30", "2024-12-01", "2024-12-02", "2024-12-03", "2024-12-04", "2024-12-05", "2024-12-06", "2024-12-07", "2024-12-08", "2024-12-09", "2024-12-10", "2024-12-11", "2024-12-12", "2024-12-13", "2024-12-14", "2024-12-15", "2024-12-16", "2024-12-17", "2024-12-18", "2024-12-19", "2024-12-20", "2024-12-21", "2024-12-22", "2024-12-23", "2024-12-24", "2024-12-25", "2024-12-26", "2024-12-27", "2024-12-28", "2024-12-29", "2024-12-30", "2024-12-31", "2025-01-01", "2025-01-02", "2025-01-03", "2025-01-04", "2025-01-05", "2025-01-06", "2025-01-07", "2025-01-08", "2025-01-09", "2025-01-10", "2025-01-11", "2025-01-12", "2025-01-13", "2025-01-14", "2025-01-15", "2025-01-16", "2025-01-17", "2025-01-18", "2025-01-19", "2025-01-20", "2025-01-21", "2025-01-22", "2025-01-23", "2025-01-24", "2025-01-25", "2025-01-26", "2025-01-27", "2025-01-28", "2025-01-29", "2025-01-30", "2025-01-31", "2025-02-01", "2025-02-02", "2025-02-03", "2025-02-04", "2025-02-05", "2025-02-06", "2025-02-07", "2025-02-08", "2025-02-09", "2025-02-10", "2025-02-11", "2025-02-12", "2025-02-13", "2025-02-14", "2025-02-15", "2025-02-16", "2025-02-17", "2025-02-18", "2025-02-19", "2025-02-20", "2025-02-21", "2025-02-22", "2025-02-23", "2025-02-24", "2025-02-25", "2025-02-26", "2025-02-27", "2025-02-28", "2025-03-01", "2025-03-02", "2025-03-03", "2025-03-04", "2025-03-05", "2025-03-06", "2025-03-07", "2025-03-08", "2025-03-09", "2025-03-10", "2025-03-11", "2025-03-12", "2025-03-13", "2025-03-14", "2025-03-15", "2025-03-16", "2025-03-17", "2025-03-18", "2025-03-19", "2025-03-20", "2025-03-21", "2025-03-22", "2025-03-23", "2025-03-24", "2025-03-25", "2025-03-26", "2025-03-27", "2025-03-28", "2025-03-29", "2025-03-30", "2025-03-31", "2025-04-01", "2025-04-02", "2025-04-03", "2025-04-04", "2025-04-05", "2025-04-06", "2025-04-07", "2025-04-08", "2025-04-09", "2025-04-10", "2025-04-11", "2025-04-12", "2025-04-13", "2025-04-14", "2025-04-15", "2025-04-16", "2025-04-17", "2025-04-18", "2025-04-19", "2025-04-20", "2025-04-21", "2025-04-22", "2025-04-23", "2025-04-24", "2025-04-25", "2025-04-26", "2025-04-27", "2025-04-28", "2025-04-29", "2025-04-30", "2025-05-01", "2025-05-02", "2025-05-03", "2025-05-04", "2025-05-05", "2025-05-06", "2025-05-07", "2025-05-08", "2025-05-09", "2025-05-10", "2025-05-11", "2025-05-12", "2025-05-13", "2025-05-14", "2025-05-15", "2025-05-16", "2025-05-17", "2025-05-18", "2025-05-19", "2025-05-20", "2025-05-21", "2025-05-22", "2025-05-23", "2025-05-24", "2025-05-25", "2025-05-26", "2025-05-27", "2025-05-28", "2025-05-29", "2025-05-30", "2025-05-31", "2025-06-01", "2025-06-02", "2025-06-03", "2025-06-04", "2025-06-05", "2025-06-06", "2025-06-07", "2025-06-08", "2025-06-09", "2025-06-10", "2025-06-11", "2025-06-12", "2025-06-13", "2025-06-14", "2025-06-15", "2025-06-16", "2025-06-17", "2025-06-18", "2025-06-19", "2025-06-20", "2025-06-21", "2025-06-22", "2025-06-23", "2025-06-24", "2025-06-25", "2025-06-26", "2025-06-27", "2025-06-28", "2025-06-29", "2025-06-30", "2025-07-01", "2025-07-02", "2025-07-03", "2025-07-04", "2025-07-05", "2025-07-06", "2025-07-07", "2025-07-08", "2025-07-09", "2025-07-10", "2025-07-11", "2025-07-12", "2025-07-13", "2025-07-14", "2025-07-15", "2025-07-16", "2025-07-17", "2025-07-18", "2025-07-19", "2025-07-20", "2025-07-21", "2025-07-22", "2025-07-23", "2025-07-24", "2025-07-25", "2025-07-26", "2025-07-27", "2025-07-28", "2025-07-29", "2025-07-30", "2025-07-31", "2025-08-01", "2025-08-02", "2025-08-03", "2025-08-04", "2025-08-05", "2025-08-06", "2025-08-07", "2025-08-08", "2025-08-09", "2025-08-10", "2025-08-11", "2025-08-12", "2025-08-13", "2025-08-14", "2025-08-15", "2025-08-16", "2025-08-17", "2025-08-18", "2025-08-19", "2025-08-20", "2025-08-21", "2025-08-22", "2025-08-23", "2025-08-24", "2025-08-25", "2025-08-26", "2025-08-27", "2025-08-28", "2025-08-29", "2025-08-30", "2025-08-31", "2025-09-01", "2025-09-02", "2025-09-03", "2025-09-04", "2025-09-05", "2025-09-06", "2025-09-07", "2025-09-08", "2025-09-09", "2025-09-10", "2025-09-11", "2025-09-12", "2025-09-13", "2025-09-14", "2025-09-15", "2025-09-16", "2025-09-17", "2025-09-18", "2025-09-19", "2025-09-20", "2025-09-21", "2025-09-22", "2025-09-23", "2025-09-24", "2025-09-25", "2025-09-26", "2025-09-27", "2025-09-28", "2025-09-29", "2025-09-30", "2025-10-01", "2025-10-02", "2025-10-03", "2025-10-04", "2025-10-05", "2025-10-06", "2025-10-07", "2025-10-08", "2025-10-09", "2025-10-10", "2025-10-11", "2025-10-12", "2025-10-13", "2025-10-14", "2025-10-15", "2025-10-16", "2025-10-17", "2025-10-18", "2025-10-19", "2025-10-20", "2025-10-21", "2025-10-22", "2025-10-23", "2025-10-24", "2025-10-25", "2025-10-26", "2025-10-27", "2025-10-28", "2025-10-29", "2025-10-30", "2025-10-31", "2025-11-01", "2025-11-02", "2025-11-03", "2025-11-04", "2025-11-05", "2025-11-06", "2025-11-07", "2025-11-08", "2025-11-09", "2025-11-10", "2025-11-11", "2025-11-12", "2025-11-13", "2025-11-14", "2025-11-15", "2025-11-16", "2025-11-17", "2025-11-18", "2025-11-19", "2025-11-20", "2025-11-21", "2025-11-22", "2025-11-23", "2025-11-24", "2025-11-25", "2025-11-26", "2025-11-27", "2025-11-28", "2025-11-29", "2025-11-30", "2025-12-01", "2025-12-02", "2025-12-03", "2025-12-04", "2025-12-05", "2025-12-06", "2025-12-07", "2025-12-08", "2025-12-09", "2025-12-10", "2025-12-11", "2025-12-12", "2025-12-13", "2025-12-14", "2025-12-15", "2025-12-16", "2025-12-17", "2025-12-18", "2025-12-19", "2025-12-20", "2025-12-21", "2025-12-22", "2025-12-23", "2025-12-24", "2025-12-25", "2025-12-29", "2025-12-30", "2025-12-31", "2026-01-01", "2026-01-02", "2026-01-03", "2026-01-04", "2026-01-05", "2026-01-06", "2026-01-07", "2026-01-08", "2026-01-09", "2026-01-10", "2026-01-11", "2026-01-12", "2026-01-13", "2026-01-14", "2026-01-15", "2026-01-16", "2026-01-17", "2026-01-18", "2026-01-19", "2026-01-20", "2026-01-21", "2026-01-22", "2026-01-23", "2026-01-24", "2026-01-25", "2026-01-26", "2026-01-27", "2026-01-28", "2026-01-29", "2026-01-30", "2026-01-31", "2026-02-01", "2026-02-02", "2026-02-03", "2026-02-04"];
        const HIST_R_STAKE = [2.31, 2.15, 2.28, 2.28, 2.23, 2.17, 2.29, 2.29, 2.09, 2.09, 1.91, 1.91, 2.02, 2.02, 1.89, 1.89, 1.89, 1.63, 2.03, 2.03, 2.03, 1.98, 1.98, 1.96, 1.89, 1.8, 2.04, 2.04, 2.04, 2, 1.93, 1.93, 1.8, 1.8, 1.93, 1.93, 1.81, 1.81, 1.89, 1.89, 1.94, 1.94, 1.79, 1.79, 1.79, 1.93, 1.93, 2.02, 1.57, 1.67, 1.67, 4.44, 4.27, 4.16, 4.28, 4.28, 4.12, 4.03, 4.03, 3.93, 3.93, 4.38, 4.38, 4.46, 4.23, 4.23, 4.74, 4.74, 4.56, 4.56, 5.16, 5.16, 5.07, 5.18, 5.18, 5.23, 5.23, 5.26, 5.26, 5.17, 5.52, 2.75, 2.95, 2.95, 3.05, 3.05, 2.96, 3.09, 3.09, 3.5, 3.5, 3.2, 3.2, 3.13, 3.5, 3.5, 3.29, 3.29, 3.54, 3.54, 2.88, 3.05, 3.05, 3.17, 3.17, 3.09, 3.09, 2.96, 3.04, 3.04, 2.92, 2.92, 2.94, 2.94, 2.73, 2.98, 2.98, 2.96, 2.96, 2.74, 2.74, 2.85, 2.89, 2.89, 2.9, 2.9, 2.91, 2.91, 2.59, 2.7, 3.35, 3.8, 3.8, 3.63, 3.63, 3.53, 3.67, 3.67, 3.71, 3.71, 3.65, 3.65, 3.97, 3.93, 3.93, 3.74, 3.88, 3.61, 3.67, 3.67, 4.03, 4.03, 3.71, 3.86, 3.86, 3.79, 3.14, 2.55, 2.55, 3.18, 3.21, 3.21, 3.16, 3.16, 3.13, 3.13, 3.07, 3.07, 2.76, 2.56, 2.62, 3.16, 3.16, 3.13, 3.13, 3.26, 3.16, 3.16, 3.13, 3.13, 2.4, 2.95, 2.99, 2.88, 2.88, 2.91, 3.12, 3.15, 3.22, 2.58, 2.59, 2.67, 3.01, 3.05, 3.01, 3.06, 3, 3.05, 3.51, 3.47, 3.46, 2.84, 2.9, 2.89, 2.95, 2.88, 2.91, 2.97, 2.97, 3.04, 3.12, 2.77, 2.8, 3.08, 3.2, 3.19, 3.07, 3.07, 3.07, 3.09, 3.18, 3.18, 2.82, 2.85, 2.89, 2.92, 3.17, 3.19, 2.81, 2.78, 2.8, 2.81, 2.82, 3.01, 3.02, 3.03, 3.04, 3.06, 3.05, 3.05, 3.1, 3.07, 3.07, 2.83, 2.8, 2.79, 2.79, 2.85, 2.86, 2.87, 2.8, 2.8, 2.81, 2.81, 2.81, 2.81, 2.86, 2.86, 2.86, 2.89, 2.9, 2.9, 2.91, 2.75, 2.83, 2.83, 2.83, 2.83, 2.83, 3.1, 3.06, 3.1, 3.11, 3.11, 3.1, 3.15, 3.15, 3.08, 3.08, 3.09, 3.09, 3.08, 3.3, 3.29, 3.29, 3.27, 3, 2.99, 2.99, 3.1, 3.1, 3.13, 3.13, 3.13, 3.08, 3.08, 3.17, 3.19, 3.21, 2.95, 2.94, 2.8, 2.8, 2.88, 2.88, 2.89, 2.91, 2.91, 2.92, 2.9, 3.13, 3.13, 2.9, 2.9, 2.9, 2.9, 2.9, 3.03, 3.02, 2.88, 2.88, 2.85, 2.85, 2.84, 2.9, 2.96, 2.87, 2.89, 2.87, 2.87, 2.86, 3.03, 3.14, 3.06, 3.07, 3.03, 3.02, 3.02, 3.17, 3.17, 3, 2.94, 2.95, 2.94, 2.92, 3.07, 3.07, 2.94, 2.96, 2.96, 2.96, 2.96, 3.04, 3.04, 3.01, 2.9, 2.88, 2.85, 2.84, 3.03, 3.03, 2.84, 2.73, 2.72, 2.72, 2.74, 2.87, 2.87, 2.72, 2.72, 2.73, 2.73, 2.73, 2.88, 2.9, 2.75, 2.75, 2.83, 2.75, 2.74, 2.84, 2.84, 2.74, 2.74, 2.75, 2.75, 2.75, 2.97, 2.98, 2.79, 2.79, 2.79, 2.79, 2.78, 2.94, 2.91, 2.76, 2.76, 2.75, 2.74, 2.72, 2.88, 2.87, 2.73, 2.71, 2.71, 2.7, 2.62, 2.79, 2.79, 2.69, 2.69, 2.69, 2.69, 2.67, 2.88, 2.87, 2.65, 2.63, 2.62, 2.62, 2.62, 2.79, 2.79, 2.6, 2.6, 2.6, 2.6, 2.6, 2.76, 2.77, 2.59, 2.6, 2.6, 2.6, 2.6, 2.71, 2.71, 2.6, 2.6, 2.59, 2.59, 2.59, 2.82, 2.88, 2.6, 2.6, 2.6, 2.59, 2.59, 2.78, 2.78, 2.6, 2.59, 2.64, 2.59, 2.59, 2.76, 2.76, 2.59, 2.6, 2.6, 2.62, 2.61, 2.79, 2.79, 2.67, 2.67, 2.69, 2.69, 2.69, 2.75, 2.76, 2.52, 2.73, 2.69, 2.68, 2.68, 2.76, 2.77, 2.58, 2.7, 2.7, 2.7, 2.7, 2.84, 2.83, 2.67, 2.65, 2.68, 2.68, 2.67, 2.72, 2.7, 2.67, 2.66, 2.7, 2.66, 2.61, 2.6, 2.65, 2.75, 2.74, 2.73, 2.5, 2.55, 2.6, 2.6, 2.49, 2.58, 2.57, 2.45, 2.45, 2.57, 2.56, 2.52, 2.46, 2.44, 2.54, 2.56, 2.56, 2.57, 2.49, 2.68, 2.5, 2.5, 2.5, 2.53, 2.55, 2.72, 2.65, 2.43, 2.43, 2.43, 2.56, 2.54, 2.49, 2.49, 2.51, 2.41, 2.4, 2.57, 2.56, 2.44, 2.46, 2.36, 2.42, 2.42, 2.49, 2.42, 2.42, 2.41, 2.41, 2.36, 2.39, 2.4, 2.41, 3.21, 2.97, 2.98, 2.52, 2.47, 2.96, 2.95, 2.45, 2.46, 2.77, 2.7, 2.68, 2.68, 2.67, 2.58, 2.7, 2.51, 2.5, 2.48, 2.68, 2.7, 2.51, 2.5, 2.49, 2.49, 2.47, 2.56, 2.55, 2.53, 2.52, 2.87, 3, 2.88, 2.44, 2.44, 2.88, 3.14, 2.46, 2.46, 2.27, 2.54, 2.5, 2.5, 2.48, 3.11, 3.21, 3.08, 2.42, 2.51, 2.51, 2.5, 2.67, 2.67, 2.52, 2.52, 2.46, 2.45, 2.34, 2.52, 2.55, 2.52, 2.52, 2.83, 3.04, 2.91, 2.52, 2.52, 2.53, 2.54, 2.61, 2.36, 2.4, 2.43, 2.48, 2.34];
        const HIST_R_BORROW = [2.3, 2.44, 2.41, 2.4, 2.39, 2.37, 2.4, 2.4, 2.55, 2.51, 2.51, 2.51, 2.52, 2.45, 2.39, 2.38, 2.23, 2.28, 2.29, 2.28, 2.24, 2.24, 2.28, 2.31, 2.32, 2.31, 2.32, 2.41, 2.52, 2.49, 2.49, 2.49, 2.48, 2.47, 2.5, 2.51, 2.5, 2.46, 2.47, 2.5, 2.49, 2.5, 2.51, 2.56, 2.68, 2.58, 2.56, 2.48, 2.42, 2.5, 2.58, 4.23, 2.7, 2.69, 2.68, 2.62, 2.62, 3.11, 7.34, 4.73, 2.69, 2.69, 2.68, 2.69, 2.69, 2.66, 2.68, 2.68, 2.67, 2.58, 2.58, 2.56, 2.58, 2.57, 2.47, 2.52, 2.53, 2.7, 2.7, 2.69, 2.67, 2.68, 2.67, 2.67, 2.66, 2.63, 2.64, 2.63, 2.6, 2.61, 2.61, 2.58, 2.55, 2.54, 2.59, 2.62, 2.69, 2.69, 2.62, 2.58, 2.57, 2.58, 2.58, 2.54, 2.54, 2.5, 2.48, 2.46, 2.44, 2.43, 2.5, 2.53, 2.53, 2.58, 2.56, 2.56, 2.55, 2.55, 2.55, 2.57, 2.63, 2.63, 2.67, 2.63, 2.61, 2.56, 2.57, 2.56, 2.55, 2.55, 2.59, 2.61, 2.69, 2.68, 3.31, 2.64, 2.55, 2.56, 2.57, 2.6, 2.6, 2.62, 2.67, 5.29, 2.7, 2.7, 2.97, 2.68, 2.65, 2.7, 2.69, 5.85, 2.65, 2.7, 2.69, 2.7, 3.1, 2.68, 2.69, 2.67, 2.69, 2.69, 2.68, 2.6, 2.7, 2.69, 2.68, 2.67, 2.66, 2.69, 2.66, 2.7, 2.64, 2.68, 2.62, 2.68, 2.63, 2.62, 2.63, 2.64, 2.63, 2.65, 2.64, 2.68, 2.67, 2.64, 2.65, 2.62, 2.65, 2.61, 2.64, 2.63, 2.57, 2.63, 2.62, 2.59, 2.56, 2.55, 2.51, 2.49, 2.66, 2.67, 2.68, 2.67, 2.67, 2.67, 2.69, 2.7, 3.09, 2.68, 2.7, 2.68, 2.66, 2.7, 2.73, 3.81, 2.7, 3.64, 2.69, 2.7, 2.67, 2.66, 2.64, 2.7, 3.85, 7.59, 2.7, 2.55, 2.53, 2.54, 2.58, 2.6, 2.59, 2.59, 2.57, 2.55, 2.59, 2.57, 2.6, 2.6, 2.56, 2.58, 2.59, 2.57, 2.55, 2.55, 2.41, 2.4, 2.43, 2.43, 2.44, 2.51, 2.5, 2.52, 2.53, 2.57, 2.58, 2.66, 2.64, 2.64, 2.61, 2.56, 2.61, 2.64, 2.67, 2.67, 2.67, 2.65, 2.7, 3.19, 2.66, 2.65, 2.63, 2.65, 2.62, 2.61, 2.56, 2.51, 2.48, 2.5, 2.52, 2.51, 2.51, 2.49, 2.51, 2.51, 2.59, 2.65, 2.64, 2.64, 2.56, 2.55, 2.55, 2.58, 2.6, 2.61, 2.62, 2.61, 2.59, 2.55, 2.56, 2.61, 2.62, 2.7, 2.7, 2.69, 2.69, 2.7, 2.7, 6.18, 2.7, 2.82, 2.61, 2.62, 2.6, 2.68, 2.69, 2.68, 2.65, 2.63, 2.62, 2.63, 2.63, 2.63, 2.67, 2.65, 2.65, 2.64, 2.62, 2.62, 2.66, 2.69, 3.82, 2.68, 2.65, 2.69, 2.7, 2.68, 2.7, 2.7, 2.66, 2.66, 2.66, 2.67, 2.67, 2.65, 2.63, 2.65, 2.67, 2.65, 2.67, 2.64, 2.62, 2.6, 2.58, 2.57, 2.55, 2.53, 2.57, 2.54, 2.56, 2.53, 2.66, 2.57, 2.57, 2.56, 2.56, 2.54, 2.6, 2.59, 2.56, 2.54, 2.54, 2.53, 2.52, 2.56, 2.44, 2.46, 2.44, 2.43, 2.42, 2.43, 2.51, 2.6, 2.61, 2.62, 2.61, 2.59, 2.57, 2.56, 2.59, 2.58, 2.59, 2.58, 2.59, 2.59, 2.62, 2.58, 2.59, 2.59, 2.6, 2.6, 2.6, 2.59, 2.59, 2.59, 2.6, 2.56, 2.55, 2.57, 2.52, 2.52, 2.52, 2.51, 2.51, 2.51, 2.51, 2.51, 2.49, 2.58, 2.58, 2.57, 2.58, 2.59, 2.59, 2.62, 2.69, 2.69, 2.68, 5.34, 6.95, 2.67, 7.24, 6.58, 2.66, 6.58, 4.24, 4.36, 3.0, 2.97, 2.97, 2.99, 2.89, 2.9, 2.95, 3.04, 2.89, 2.89, 4.25, 3.09, 2.88, 2.84, 2.82, 2.77, 2.69, 2.64, 2.65, 2.49, 2.52, 2.57, 2.66, 2.66, 2.66, 2.66, 2.66, 4.01, 2.65, 2.61, 2.6, 2.62, 2.63, 2.61, 2.61, 2.61, 2.65, 2.65, 2.66, 2.64, 2.63, 2.64, 2.62, 2.6, 2.59, 2.58, 2.59, 2.59, 2.57, 2.54, 2.49, 2.48, 2.47, 2.47, 2.45, 2.35, 2.32, 2.28, 2.24, 2.24, 2.24, 2.31, 2.32, 2.3, 2.34, 2.28, 2.29, 2.25, 2.26, 2.25, 2.3, 2.3, 2.31, 2.31, 2.39, 2.39, 2.38, 2.41, 2.35, 2.35, 2.38, 2.42, 2.4, 2.4, 2.4, 2.4, 2.45, 2.44, 2.46, 2.53, 2.54, 2.53, 2.52, 2.52, 2.49, 2.47, 2.45, 2.44, 2.44, 2.46, 2.46, 2.47, 2.46, 2.46, 2.48, 2.49, 2.52, 2.45, 2.49, 2.48, 2.36, 2.27, 2.2, 2.08, 2.02, 2.15, 2.07, 2.07, 2.09, 2.09, 2.04, 2.02, 2.03, 2.01, 2.01, 1.95, 1.97, 1.98, 1.99, 1.92, 1.93, 1.85, 1.83, 1.85, 1.84, 1.83, 1.83, 1.83, 1.86, 1.9, 1.95, 1.98, 1.97, 1.97, 1.94, 1.96, 1.96, 1.95, 1.96, 2.03, 2.03, 2.04, 2.04, 2.03, 2.01, 2.0, 1.96, 1.97, 1.98, 1.96, 1.97, 1.98, 1.98, 1.98, 1.99, 2.0, 2.0, 2.02, 2.03, 2.03, 2.03, 2.04, 2.04, 2.07, 2.06, 1.94, 1.94, 1.95, 2.02, 2.09, 2.12, 2.14, 2.13, 2.13, 2.06, 2.11, 2.14, 2.2, 2.19, 2.22, 2.19, 2.23, 2.28, 2.3];

        // stETH Historical APR data (uses rsETH dates & WETH borrow, approximate staking yield)
        const STETH_HIST_DATES = HIST_DATES;
        const STETH_HIST_R_STAKE = STETH_YIELD_HISTORY.slice(0, HIST_DATES.length);
        const STETH_HIST_R_BORROW = HIST_R_BORROW;

        // Token data lookup for sensitivity/historical toggle
        const TOKEN_DATA = {
            rseth: {
                label: 'rsETH', source: 'rsETH yield (Kelp DAO)',
                yieldHist: RSETH_YIELD_HISTORY,
                histDates: HIST_DATES, histStake: HIST_R_STAKE, histBorrow: HIST_R_BORROW,
            },
            eeth: {
                label: 'eETH', source: 'eETH yield (ether.fi)',
                yieldHist: EETH_HIST_R_STAKE,
                histDates: EETH_HIST_DATES, histStake: EETH_HIST_R_STAKE, histBorrow: EETH_HIST_R_BORROW,
            },
            steth: {
                label: 'stETH', source: 'stETH yield (Lido, approx.)',
                yieldHist: STETH_YIELD_HISTORY,
                histDates: STETH_HIST_DATES, histStake: STETH_HIST_R_STAKE, histBorrow: STETH_HIST_R_BORROW,
            },
        };

        // =====================================================================
        // Economic Formulas (ported from Python)
        // =====================================================================

        function psi(liqLtvT, betaSafe, liqLtvClp, liqLtvC) {
            return liqLtvT / (betaSafe * liqLtvClp) - liqLtvC / liqLtvClp;
        }

        function interestRate(u, iMin, i0, u0, iMax, gamma) {
            const linearSlope = (i0 - iMin) / u0;
            const nonlinearCoeff = iMax - iMin - linearSlope;
            return iMin + linearSlope * u + nonlinearCoeff * Math.pow(u, gamma);
        }

        function ltvFromHf(liqLtvT, hf) {
            return liqLtvT / hf;
        }

        function leverageFromLtv(lambdaT) {
            return 1.0 / (1.0 - lambdaT);
        }

        function loopedYield(rStake, rBorrow, lambdaT, irU, psiVal) {
            const numerator = rStake - rBorrow * lambdaT - irU * psiVal;
            const denominator = 1.0 - lambdaT;
            return numerator / denominator;
        }

        // Net APY for an Aave-only looped position
        function aaveNetApy(leverage, rSupply, rBorrow) {
            return leverage * rSupply - (leverage - 1) * rBorrow;
        }

        // Net APY for a Twyne looped position (reuses loopedYield)
        function twyneNetApy(leverage, rSupply, rBorrow, irU, psiVal) {
            const ltv = 1 - 1 / leverage;
            return loopedYield(rSupply, rBorrow, ltv, irU, psiVal);
        }

        // Minimum psi (credit requirement) to achieve a given leverage
        function minPsiForLeverage(leverage, borrowLtvE, liqLtvE, betaSafe) {
            const requiredBorrowLtv = 1 - 1 / leverage;
            const requiredLiqLtvT = requiredBorrowLtv * liqLtvE / borrowLtvE;
            if (requiredLiqLtvT <= liqLtvE) return 0;
            return psi(requiredLiqLtvT, betaSafe, liqLtvE, liqLtvE);
        }

        // Compute position details for a given leverage and equity
        function positionDetails(equity, leverage) {
            const collateral = equity * leverage;
            const debt = equity * (leverage - 1);
            const ltv = debt / collateral;
            return { collateral, debt, ltv };
        }

        // =====================================================================
        // Dashboard State & Updates
        // =====================================================================

        let tvlMultiplierMode = false;
        let _tvlCache = null;
        let _scenarioBeyondLevels = [];
        let _sensToken = 'rseth';

        function formatNum(n) {
            if (n >= 1000000000) return '$' + (n / 1000000000).toFixed(1) + 'B';
            if (n >= 1000000) return '$' + (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return '$' + (n / 1000).toFixed(0) + 'K';
            return '$' + n.toFixed(0);
        }

        function toggleTvlMode() {
            tvlMultiplierMode = !tvlMultiplierMode;
            const knob = document.getElementById('tvlToggleKnob');
            const toggle = document.getElementById('tvlToggle');
            const labelLeft = document.getElementById('tvlToggleLabel');
            const labelRight = document.getElementById('tvlToggleLabelRight');
            if (tvlMultiplierMode) {
                knob.style.left = '16px';
                toggle.style.background = 'var(--accent-green)';
                labelRight.style.color = 'var(--text-primary)';
                labelLeft.style.color = 'var(--text-secondary)';
            } else {
                knob.style.left = '2px';
                toggle.style.background = 'var(--border-color)';
                labelLeft.style.color = 'var(--text-primary)';
                labelRight.style.color = 'var(--text-secondary)';
            }
            applyTvlDisplayMode();
        }

        function applyTvlDisplayMode() {
            if (!_tvlCache) return;
            const { maxTvl, minTvl, seed, chartBorrowLtvs, chartTvls, miniLayout } = _tvlCache;

            // Update card
            if (tvlMultiplierMode) {
                document.getElementById('summaryMaxTvl').textContent = (maxTvl / seed).toFixed(1) + 'x';
                document.getElementById('summaryMinTvl').textContent = (minTvl / seed).toFixed(1) + 'x';
            } else {
                document.getElementById('summaryMaxTvl').textContent = formatNum(maxTvl);
                document.getElementById('summaryMinTvl').textContent = formatNum(minTvl);
            }

            // Update chart title
            document.getElementById('tvlChartTitle').textContent = tvlMultiplierMode
                ? 'TVL Multiplier by Borrow LTV' : 'Generated TVL by Borrow LTV';

            // Re-render chart
            var chartY = tvlMultiplierMode ? chartTvls.map(function(v) { return v / seed; }) : chartTvls;
            var hover = tvlMultiplierMode
                ? 'LTV: %{x:.1f}%<br>Multiplier: %{y:.1f}x<extra></extra>'
                : 'LTV: %{x:.1f}%<br>TVL: $%{y:,.0f}<extra></extra>';
            var yaxis = tvlMultiplierMode
                ? { color: '#8a9bb5', gridcolor: 'rgba(138,155,181,0.1)', ticksuffix: 'x' }
                : { color: '#8a9bb5', gridcolor: 'rgba(138,155,181,0.1)', tickprefix: '$', tickformat: ',.0s' };

            Plotly.newPlot('tvlByLtvChart', [{
                x: chartBorrowLtvs, y: chartY, type: 'scatter', mode: 'lines',
                line: { color: '#9c7cf4', width: 2 },
                fill: 'tozeroy', fillcolor: 'rgba(156,124,244,0.08)',
                hovertemplate: hover
            }], {
                margin: { t: 4, r: 12, b: 32, l: 50 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#8a9bb5', size: 10 },
                xaxis: { title: '', color: '#8a9bb5', gridcolor: 'rgba(138,155,181,0.1)', ticksuffix: '%', dtick: 1 },
                yaxis: yaxis
            }, { responsive: true, displayModeBar: false });
        }

        function getParams() {
            return {
                stethStaking: parseFloat(document.getElementById('stethStaking').value) / 100,
                stethLending: parseFloat(document.getElementById('stethLending').value) / 100,
                ethBorrow: parseFloat(document.getElementById('ethBorrow').value) / 100,
                liqLtvT: parseFloat(document.getElementById('liqLtvT').value) / 100,
                liqLtvE: parseFloat(document.getElementById('liqLtvE').value) / 100,
                borrowLtvE: parseFloat(document.getElementById('borrowLtvE').value) / 100,
                betaSafe: parseFloat(document.getElementById('betaSafe').value) / 100,
                iMin: parseFloat(document.getElementById('iMin').value) / 100,
                iMax: parseFloat(document.getElementById('iMax').value) / 100,
                i0: parseFloat(document.getElementById('i0').value) / 100,
                u0: parseFloat(document.getElementById('u0').value) / 100,
                gamma: parseFloat(document.getElementById('gamma').value),
                clpDeposited: parseFloat(document.getElementById('clpDeposited').value.replace(/,/g, '')),
                hfMin: parseFloat(document.getElementById('hfMin').value),
                hfMax: parseFloat(document.getElementById('hfMax').value),
                utilization: parseFloat(document.getElementById('utilization').value) / 100,
            };
        }

        function updateStats() {
            const p = getParams();
            const totalYield = (p.stethStaking + p.stethLending) * 100;
            const spread = totalYield - p.ethBorrow * 100;
            const psiVal = psi(p.liqLtvT, p.betaSafe, p.liqLtvE, p.liqLtvE);

            document.getElementById('psiValue').textContent = (psiVal * 100).toFixed(2) + '%';

            // Calculate Twyne's effective borrow LTV
            // Twyne borrow LTV = borrowLTV_e × liqLTV_t / (β × liqLTV_e)
            const twyneBorrowLtv = p.borrowLtvE * p.liqLtvT / p.liqLtvE;

            document.getElementById('summaryBorrowLtvTwyne').textContent = (twyneBorrowLtv * 100).toFixed(1) + '%';

            // Max leverage calculations (used by other sections)
            const aaveMaxLev = leverageFromLtv(p.borrowLtvE);
            const twyneMaxLev = leverageFromLtv(twyneBorrowLtv);
        }

        function updateHeatmap() {
            const p = getParams();
            const rStake = p.stethStaking + p.stethLending;
            const rBorrow = p.ethBorrow;
            const psiVal = psi(p.liqLtvT, p.betaSafe, p.liqLtvE, p.liqLtvE);
            const irU = interestRate(p.utilization, p.iMin, p.i0, p.u0, p.iMax, p.gamma);

            // Generate HF values (low to high for display)
            const nHf = 5;
            const hfValues = [];
            for (let i = 0; i < nHf; i++) {
                hfValues.push(p.hfMin + (p.hfMax - p.hfMin) * i / (nHf - 1));
            }

            // Generate LTV values from Aave to Twyne
            const ltvStart = Math.floor(p.liqLtvE * 100);
            const ltvEnd = Math.floor(p.liqLtvT * 100);
            const ltvValues = [];
            for (let ltv = ltvStart; ltv <= ltvEnd; ltv++) {
                ltvValues.push(ltv / 100);
            }

            // Compute yield grid
            const yieldGrid = [];
            const textGrid = [];
            for (let i = 0; i < hfValues.length; i++) {
                const row = [];
                const textRow = [];
                for (let j = 0; j < ltvValues.length; j++) {
                    const lambdaT = ltvFromHf(ltvValues[j], hfValues[i]);
                    const psiLtv = psi(ltvValues[j], p.betaSafe, p.liqLtvE, p.liqLtvE);
                    const yieldVal = loopedYield(rStake, rBorrow, lambdaT, irU, psiLtv) * 100;
                    row.push(yieldVal);
                    textRow.push(yieldVal.toFixed(1) + '%');
                }
                yieldGrid.push(row);
                textGrid.push(textRow);
            }

            const xLabels = ltvValues.map(v => (v * 100).toFixed(0));
            const yLabels = hfValues.map(v => v.toFixed(2));

            const data = [{
                z: yieldGrid,
                x: xLabels,
                y: yLabels,
                type: 'heatmap',
                colorscale: [[0, '#1a1730'], [0.25, '#2d2252'], [0.5, '#4a3a80'], [0.75, '#7a5ec0'], [1, '#9c7cf4']],
                showscale: true,
                colorbar: {
                    title: 'Yield %',
                    titlefont: { color: '#9aa0a6' },
                    tickfont: { color: '#9aa0a6' }
                },
                text: textGrid,
                texttemplate: '%{text}',
                textfont: { size: 11, color: '#c8d6e0' },
                hovertemplate: 'Liq LTV: %{x}%<br>HF: %{y}<br>Yield: %{z:.1f}%<extra></extra>',
            }];

            const shapes = [];
            const annotations = [];

            const layout = {
                xaxis: {
                    title: 'Boosted Liquidation LTV %',
                    color: '#9aa0a6',
                    gridcolor: 'rgba(156,124,244,0.12)',
                    type: 'category',
                },
                yaxis: {
                    title: 'Health Factor',
                    color: '#9aa0a6',
                    gridcolor: 'rgba(156,124,244,0.12)',
                    type: 'category',
                },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                margin: { t: 10, r: 70, b: 44, l: 60 },
                height: 240,
                shapes: shapes,
                annotations: annotations,
            };

            Plotly.newPlot('yieldHeatmap', data, layout, { responsive: true });
        }

        function updateKeyInsight() {
            const p = getParams();

            const psiMax = psi(p.liqLtvT, p.betaSafe, p.liqLtvE, p.liqLtvE);
            const tvlMultiplier = psiMax > 0 ? 1 / psiMax : 0;

            // Beta warning box
            const betaWarningBox = document.getElementById('betaWarningBox');
            if (p.betaSafe < 1.0) {
                betaWarningBox.style.display = 'block';

                const psiBetaOne = psi(p.liqLtvT, 1.0, p.liqLtvE, p.liqLtvE);
                const multBetaOne = psiBetaOne > 0 ? 1 / psiBetaOne : 0;
                const efficiencyLoss = ((multBetaOne - tvlMultiplier) / multBetaOne * 100).toFixed(0);

                document.getElementById('betaOneMultiplier').textContent = multBetaOne.toFixed(1);
                document.getElementById('currentBetaDisplay').textContent = (p.betaSafe * 100).toFixed(0) + '%';
                document.getElementById('currentBetaMultiplier').textContent = tvlMultiplier.toFixed(1);
                document.getElementById('betaEfficiencyLoss').textContent = efficiencyLoss + '% drop';
            } else {
                betaWarningBox.style.display = 'none';
            }
        }

        function updateTvlTradeoffChart() {
            const p = getParams();

            // Get CLP amount from sidebar input
            const clpAmount = parseFloat(document.getElementById('clpDeposited').value.replace(/,/g, '')) || 1000000;

            // Get HF from input
            const hf = parseFloat(document.getElementById('tradeoffHfInput').value) || 1.02;

            // Update Net Yield tooltip with current HF
            document.getElementById('netYieldHeader').setAttribute('data-tip',
                `Annualized yield including Twyne credit cost at HF ${hf.toFixed(2)}.`);

            // Rates for yield calculation
            const rStake = p.stethStaking + p.stethLending;
            const rBorrow = p.ethBorrow;
            const irU = interestRate(p.utilization, p.iMin, p.i0, p.u0, p.iMax, p.gamma);

            // Generate 5 evenly spaced LTV points
            const ltvStart = p.liqLtvE + 0.005;  // Just above Aave liq LTV
            const ltvEnd = p.liqLtvT;
            const numPoints = tradeoffRowCount;

            const dataPoints = [];
            let maxTvl = 0;

            for (let i = 0; i < numPoints; i++) {
                const liqLtvT = ltvStart + (ltvEnd - ltvStart) * (i / (numPoints - 1));
                const psiVal = psi(liqLtvT, p.betaSafe, p.liqLtvE, p.liqLtvE);

                if (psiVal <= 0) continue;

                const borrowerCollateral = clpAmount / psiVal;
                const tvl = borrowerCollateral + clpAmount;  // borrower collateral + CLP

                // Twyne borrow LTV at this liq LTV
                const twyneBorrowLtv = p.borrowLtvE * liqLtvT / p.liqLtvE;
                const twyneLeverage = leverageFromLtv(twyneBorrowLtv);
                const borrowerEquity = borrowerCollateral / twyneLeverage;

                // Calculate net looping yield
                // Operating LTV = liq LTV / HF
                const operatingLtv = liqLtvT / hf;
                const netYield = loopedYield(rStake, rBorrow, operatingLtv, irU, psiVal);

                if (tvl > maxTvl) maxTvl = tvl;

                dataPoints.push({
                    liqLtv: liqLtvT,
                    borrowLtv: twyneBorrowLtv,
                    tvl: tvl,
                    borrowerEquity: borrowerEquity,
                    netYield: netYield,
                    psi: psiVal
                });
            }

            const tbody = document.querySelector('#tvlTradeoffTable tbody');
            tbody.innerHTML = '';

            // Add Aave baseline row first
            const aaveLeverage = leverageFromLtv(p.borrowLtvE);
            const aaveOperatingLtv = p.liqLtvE / hf;
            const aaveYield = loopedYield(rStake, rBorrow, aaveOperatingLtv, 0, 0);  // No Twyne fees (psi=0, IR=0)
            const aaveTvl = clpAmount * aaveLeverage;  // If you loop yourself
            const aaveEquity = clpAmount;  // Your own capital
            const aaveYieldPct = (aaveYield * 100).toFixed(1);
            const aaveYieldColor = aaveYield >= 0 ? 'var(--accent-green)' : 'var(--accent-orange)';

            const aaveRow = document.createElement('tr');
            aaveRow.className = 'box-single';
            aaveRow.innerHTML = `
                <td>—</td>
                <td style="color: var(--text-secondary);">${aaveLeverage.toFixed(1)}x</td>
                <td style="color: var(--text-secondary); font-weight: 600;">${aaveYieldPct}% <span style="font-size: 0.75rem;">(+0.0%)</span></td>
                <td style="color: var(--text-secondary);">—</td>
            `;
            tbody.appendChild(aaveRow);

            const minEquity = Math.min(...dataPoints.map(d => d.borrowerEquity));
            const clpYield = p.utilization * irU * 100;
            document.getElementById('topSeedAmount').textContent = formatNum(clpAmount);
            document.getElementById('topClpYield').textContent = clpYield.toFixed(2) + '%';

            // Helper: update callout with a given data point
            function selectTradeoffRow(point, rowEl) {
                // Clear previous selection
                tbody.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
                if (rowEl) rowEl.classList.add('selected');

                const lev = leverageFromLtv(point.borrowLtv);
                document.getElementById('qGeneratedTvl').textContent = formatNum(point.tvl);
                document.getElementById('qClpSeed').textContent = formatNum(clpAmount);
                document.getElementById('qClpBaseYield').textContent = ((p.stethStaking + p.stethLending) * 100).toFixed(2) + '%';
                document.getElementById('qClpRate').textContent = clpYield.toFixed(2) + '%';
                document.getElementById('qBorrowerEquity').textContent = formatNum(point.borrowerEquity);
                document.getElementById('qLeverage').textContent = lev.toFixed(1) + 'x';
                document.getElementById('qNetYield').textContent = (point.netYield * 100).toFixed(2) + '%';
            }

            const defaultSelectedIdx = Math.floor(dataPoints.length / 2);
            const rows = [];

            dataPoints.forEach((point, idx) => {
                const leverage = leverageFromLtv(point.borrowLtv);
                const yieldPct = (point.netYield * 100).toFixed(1);
                const yieldDelta = (point.netYield - aaveYield) * 100;
                const deltaStr = yieldDelta >= 0 ? '+' + yieldDelta.toFixed(1) : yieldDelta.toFixed(1);

                const row = document.createElement('tr');
                const last = dataPoints.length - 1;
                if (idx === 0 && last === 0) row.className = 'box-single';
                else if (idx === 0) row.className = 'box-top';
                else if (idx === last) row.className = 'box-bottom';
                else row.className = 'box-mid';
                row.innerHTML = `
                    <td>${formatNum(point.borrowerEquity)}</td>
                    <td style="color: var(--text-secondary);">${leverage.toFixed(1)}x</td>
                    <td style="color: var(--text-secondary); font-weight: 600;">${yieldPct}% <span style="font-size: 0.75rem;">(${deltaStr}%)</span></td>
                    <td style="font-weight: 600;">${formatNum(point.tvl)}<span class="row-select-icon">&#9679;</span></td>
                `;
                row.addEventListener('click', () => selectTradeoffRow(point, row));
                tbody.appendChild(row);
                rows.push(row);
            });

            // Build side labels column (1 Aave row, N Twyne rows)
            const labelsEl = document.getElementById('tableLabels');
            const nTwyne = dataPoints.length;
            // Use flex proportions: 1 part Aave, N parts Twyne
            labelsEl.innerHTML = `
                <div class="label-cell" style="flex: 1;">
                    <img src="icons/aave_logo_light.png" alt="Aave">
                </div>
                <div class="label-cell" style="flex: ${nTwyne};">
                    <img src="icons/twyne_logo_white_full.png" alt="Twyne">
                </div>
            `;

            // Update exec summary cards
            if (dataPoints.length > 0) {
                const lastPt = dataPoints[dataPoints.length - 1];
                const firstPt = dataPoints[0];
                const maxLeverage = leverageFromLtv(lastPt.borrowLtv);
                const minLeverage = leverageFromLtv(firstPt.borrowLtv);

                document.getElementById('summaryMaxTvl').textContent = formatNum(firstPt.tvl);
                document.getElementById('summaryMinTvl').textContent = formatNum(lastPt.tvl);
                document.getElementById('summaryClpDeposited').textContent = formatNum(clpAmount);
                document.getElementById('summaryLevMin').textContent = minLeverage.toFixed(1) + 'x';
                document.getElementById('summaryLevMax').textContent = maxLeverage.toFixed(1) + 'x';
                document.getElementById('summaryAaveLev').textContent = aaveLeverage.toFixed(1) + 'x';
            }

            // Select mid-range row by default
            if (dataPoints.length > 0) {
                selectTradeoffRow(dataPoints[defaultSelectedIdx], rows[defaultSelectedIdx]);
            }

            // --- Mini charts: TVL and Leverage vs Borrow LTV ---
            const chartPoints = 30;
            const cLtvStart = p.liqLtvE + 0.005;
            const cLtvEnd = p.liqLtvT;
            const chartBorrowLtvs = [];
            const chartTvls = [];
            const chartLevs = [];
            for (let i = 0; i < chartPoints; i++) {
                const liqLtv = cLtvStart + (cLtvEnd - cLtvStart) * (i / (chartPoints - 1));
                const psiVal = psi(liqLtv, p.betaSafe, p.liqLtvE, p.liqLtvE);
                if (psiVal <= 0) continue;
                const bCollateral = clpAmount / psiVal;
                const tvl = bCollateral + clpAmount;
                const bLtv = p.borrowLtvE * liqLtv / p.liqLtvE;
                chartBorrowLtvs.push(bLtv * 100);
                chartTvls.push(tvl);
                chartLevs.push(leverageFromLtv(bLtv));
            }

            const miniLayout = {
                margin: { t: 4, r: 12, b: 32, l: 50 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#8a9bb5', size: 10 },
                xaxis: { title: '', color: '#8a9bb5', gridcolor: 'rgba(138,155,181,0.1)', ticksuffix: '%', dtick: 1 },
                yaxis: { color: '#8a9bb5', gridcolor: 'rgba(138,155,181,0.1)' },
            };

            // Cache data for toggle
            _tvlCache = {
                maxTvl: dataPoints.length > 0 ? dataPoints[0].tvl : 0,
                minTvl: dataPoints.length > 0 ? dataPoints[dataPoints.length - 1].tvl : 0,
                seed: clpAmount,
                chartBorrowLtvs: chartBorrowLtvs,
                chartTvls: chartTvls,
                miniLayout: miniLayout,
            };

            // Render TVL chart (respects current toggle mode)
            const chartTvlY = tvlMultiplierMode ? chartTvls.map(v => v / clpAmount) : chartTvls;
            const tvlHover = tvlMultiplierMode
                ? 'LTV: %{x:.1f}%<br>Multiplier: %{y:.1f}x<extra></extra>'
                : 'LTV: %{x:.1f}%<br>TVL: $%{y:,.0f}<extra></extra>';
            const tvlYaxis = tvlMultiplierMode
                ? { ...miniLayout.yaxis, ticksuffix: 'x' }
                : { ...miniLayout.yaxis, tickprefix: '$', tickformat: ',.0s' };
            document.getElementById('tvlChartTitle').textContent = tvlMultiplierMode
                ? 'TVL Multiplier by Borrow LTV' : 'Generated TVL by Borrow LTV';
            if (tvlMultiplierMode && dataPoints.length > 0) {
                document.getElementById('summaryMaxTvl').textContent = (dataPoints[0].tvl / clpAmount).toFixed(1) + 'x';
                document.getElementById('summaryMinTvl').textContent = (dataPoints[dataPoints.length - 1].tvl / clpAmount).toFixed(1) + 'x';
            }
            Plotly.newPlot('tvlByLtvChart', [{
                x: chartBorrowLtvs, y: chartTvlY, type: 'scatter', mode: 'lines',
                line: { color: '#9c7cf4', width: 2 },
                fill: 'tozeroy', fillcolor: 'rgba(156,124,244,0.08)',
                hovertemplate: tvlHover
            }], {
                ...miniLayout,
                yaxis: tvlYaxis
            }, { responsive: true, displayModeBar: false });

            const levMin = Math.floor(Math.min(...chartLevs));
            Plotly.newPlot('levByLtvChart', [{
                x: chartBorrowLtvs, y: chartLevs, type: 'scatter', mode: 'lines',
                line: { color: '#9c7cf4', width: 2 },
                fill: 'tonexty', fillcolor: 'rgba(156,124,244,0.08)',
                hovertemplate: 'LTV: %{x:.1f}%<br>Leverage: %{y:.1f}x<extra></extra>'
            }], {
                ...miniLayout,
                yaxis: { ...miniLayout.yaxis, ticksuffix: 'x', rangemode: 'tozero', range: [levMin - 1, Math.ceil(Math.max(...chartLevs)) + 1] }
            }, { responsive: true, displayModeBar: false });
        }

        function updateIrmChart() {
            const p = getParams();
            const psiVal = psi(p.liqLtvT, p.betaSafe, p.liqLtvE, p.liqLtvE);
            const steps = 200;
            const utilRange = [];
            const siphonRate = [];
            const clpRate = [];

            for (let i = 0; i <= steps; i++) {
                const u = i / steps;
                utilRange.push(u * 100);
                const ir = interestRate(u, p.iMin, p.i0, p.u0, p.iMax, p.gamma);
                siphonRate.push(psiVal * ir * 10000);
                clpRate.push(u * ir * 10000);
            }

            const curU = p.utilization;
            const curIr = interestRate(curU, p.iMin, p.i0, p.u0, p.iMax, p.gamma);

            const data = [
                {
                    x: utilRange, y: clpRate,
                    type: 'scatter', mode: 'lines',
                    name: 'Creditor Rate',
                    line: { color: '#4a9bb5', width: 2 },
                    hovertemplate: '%{y:.2f}<extra>Creditor Rate</extra>',
                },
                {
                    x: utilRange, y: siphonRate,
                    type: 'scatter', mode: 'lines',
                    name: 'Borrower Cost',
                    line: { color: '#e0a732', width: 2 },
                    hovertemplate: '%{y:.2f}<extra>Borrower Cost</extra>',
                },
            ];

            const layout = {
                xaxis: {
                    title: { text: 'Utilization %', font: { size: 11 } },
                    color: '#9aa0a6', gridcolor: 'rgba(156,124,244,0.12)',
                    range: [80, 100], dtick: 5,
                    tickfont: { size: 10 },
                },
                yaxis: {
                    title: { text: 'bps', font: { size: 11 } },
                    color: '#9aa0a6', gridcolor: 'rgba(156,124,244,0.12)',
                    tickfont: { size: 10 },
                    rangemode: 'tozero',
                },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                margin: { t: 6, r: 12, b: 36, l: 44 },
                height: 220,
                legend: {
                    x: 0.02, y: 0.98,
                    bgcolor: 'rgba(35,43,59,0.8)',
                    font: { color: '#e8eaed', size: 10 },
                },
                hovermode: 'x unified',
                shapes: [{
                    type: 'line',
                    x0: curU * 100, x1: curU * 100,
                    y0: 0, y1: 1, yref: 'paper',
                    line: { color: '#9aa0a6', width: 1, dash: 'dash' },
                }],
            };

            document.getElementById('irmUtilDisplay').textContent = (curU * 100).toFixed(0) + '%';
            document.getElementById('irmClpRateMain').textContent = (curU * curIr * 10000).toFixed(0) + ' bps';
            document.getElementById('irmBorrowerRateMain').textContent = (psiVal * curIr * 10000).toFixed(0) + ' bps';

            Plotly.newPlot('irmChartMain', data, layout, { responsive: true, displayModeBar: false });
        }

        function updateTvlMultiplierHeatmap() {
            const p = getParams();
            const beta = p.betaSafe;

            document.getElementById('tvlHeatmapBeta').textContent = (beta * 100).toFixed(0) + '%';

            const xVals = []; // Twyne Liq LTV (75–99, 1% steps)
            for (let v = 75; v <= 99; v++) xVals.push(v);
            const yVals = []; // Aave Liq LTV (99 down to 74, 1% steps)
            for (let v = 99; v >= 74; v--) yVals.push(v);

            // Z-grid uses the current beta value for coloring
            const zGrid = [];
            const textGrid = [];

            for (let j = 0; j < yVals.length; j++) {
                const row = [];
                const textRow = [];
                for (let i = 0; i < xVals.length; i++) {
                    const ltvT = xVals[i] / 100;
                    const ltvE = yVals[j] / 100;
                    if (ltvT <= ltvE) {
                        row.push(null);
                        textRow.push('');
                    } else {
                        // Current beta multiplier
                        const psiBeta = ltvT / (beta * ltvE) - 1;
                        // Beta=1 multiplier (theoretical max)
                        const psiOne = ltvT / ltvE - 1;

                        if (psiBeta <= 0 || psiOne <= 0) {
                            row.push(null);
                            textRow.push('');
                        } else {
                            const multBeta = 1 + 1 / psiBeta;
                            const multOne = 1 + 1 / psiOne;
                            row.push(multBeta);
                            const fmtB = Math.round(multBeta);
                            const fmtO = Math.round(multOne);
                            // Show range: current β → β=1 (low to high)
                            if (beta < 1.0) {
                                textRow.push(fmtB + '–' + fmtO + 'x');
                            } else {
                                textRow.push(fmtB + 'x');
                            }
                        }
                    }
                }
                zGrid.push(row);
                textGrid.push(textRow);
            }

            const data = [{
                z: zGrid,
                x: xVals.map(v => v + '%'),
                y: yVals.map(v => v + '%'),
                type: 'heatmap',
                colorscale: [
                    [0, '#3a1f1f'],     // low multiplier — muted red (bad)
                    [0.2, '#5c3030'],
                    [0.4, '#4a3a2a'],   // mid — muted amber
                    [0.55, '#3d3a28'],
                    [0.7, '#2a3a2a'],   // high — muted green (good)
                    [0.85, '#2a4a35'],
                    [1, '#2a5a3a'],
                ],
                showscale: true,
                zmin: 1,
                zmax: 40,
                colorbar: {
                    title: 'Multiplier',
                    titlefont: { color: '#9aa0a6', size: 11 },
                    tickfont: { color: '#9aa0a6', size: 10 },
                    ticksuffix: 'x',
                },
                text: textGrid,
                texttemplate: '%{text}',
                textfont: { size: 11, color: '#c8d6e0' },
                hovertemplate: 'Twyne LTV: %{x} | Aave LTV: %{y} | Multiplier: %{z:.1f}x<extra></extra>',
                connectgaps: false,
            }];

            const layout = {
                xaxis: {
                    title: { text: 'Twyne Liq LTV', font: { size: 11 } },
                    color: '#9aa0a6',
                    gridcolor: 'rgba(156,124,244,0.12)',
                    type: 'category',
                    tickfont: { size: 10 },
                },
                yaxis: {
                    title: { text: 'Aave Liq LTV', font: { size: 11 } },
                    color: '#9aa0a6',
                    gridcolor: 'rgba(156,124,244,0.12)',
                    type: 'category',
                    tickfont: { size: 10 },
                },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                margin: { t: 10, r: 80, b: 44, l: 60 },
                height: 720,
            };

            Plotly.newPlot('tvlMultiplierHeatmap', data, layout, { responsive: true, displayModeBar: false });
        }

        let tradeoffRowCount = 5;

        document.getElementById('tradeoffRowMinus').addEventListener('click', () => {
            if (tradeoffRowCount > 2) {
                tradeoffRowCount--;
                document.getElementById('tradeoffRowCount').textContent = tradeoffRowCount;
                updateTvlTradeoffChart();
            }
        });
        document.getElementById('tradeoffRowPlus').addEventListener('click', () => {
            if (tradeoffRowCount < 20) {
                tradeoffRowCount++;
                document.getElementById('tradeoffRowCount').textContent = tradeoffRowCount;
                updateTvlTradeoffChart();
            }
        });

        function updatePositionComparison() {
            const p = getParams();
            const rSupply = p.stethStaking + p.stethLending;
            const rBorrow = p.ethBorrow;
            const irU = interestRate(p.utilization, p.iMin, p.i0, p.u0, p.iMax, p.gamma);
            const equity = parseFloat(document.getElementById('borrowerEquity').value.replace(/,/g, '')) || 1000000;

            // Derive leverage from borrow LTVs
            const aaveMaxLev = leverageFromLtv(p.borrowLtvE);
            const twyneBorrowLtv = p.borrowLtvE * p.liqLtvT / p.liqLtvE;
            const twyneMaxLev = leverageFromLtv(twyneBorrowLtv);
            const aaveMaxInt = Math.floor(aaveMaxLev);
            const twyneMaxInt = Math.floor(twyneMaxLev);

            // Build unified leverage levels: Aave range + beyond-Aave range
            const aaveLevels = [aaveMaxInt - 2, aaveMaxInt - 1, aaveMaxInt].filter(l => l >= 2);
            const beyondLevels = [];
            const beyondStart = aaveMaxInt + 1;
            if (twyneMaxInt > aaveMaxInt) {
                const range = twyneMaxInt - beyondStart;
                const count = Math.min(4, range);
                for (let i = 0; i < count; i++) {
                    beyondLevels.push(Math.round(beyondStart + (range * i / Math.max(count - 1, 1))));
                }
                if (beyondLevels[beyondLevels.length - 1] !== twyneMaxInt) {
                    beyondLevels.push(twyneMaxInt);
                }
            }
            const allLevels = [...aaveLevels, ...beyondLevels];
            const aaveMaxNetApy = aaveNetApy(aaveMaxInt, rSupply, rBorrow);
            const dash = '<span style="color:var(--text-secondary);">—</span>';

            // --- Scenario A: Aave Only ---
            const tbodyA = document.querySelector('#scenarioATable tbody');
            tbodyA.innerHTML = '';

            aaveLevels.forEach(lev => {
                const pos = positionDetails(equity, lev);
                const netApy = aaveNetApy(lev, rSupply, rBorrow);
                const apyColor = netApy >= 0 ? 'var(--accent-green)' : 'var(--accent-orange)';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dash}</td>
                    <td>${lev}x</td>
                    <td>${formatNum(pos.collateral)}</td>
                    <td>${formatNum(pos.debt)}</td>
                    <td>${(pos.ltv * 100).toFixed(1)}%</td>
                    <td style="color:${apyColor};font-weight:600;">${(netApy * 100).toFixed(2)}%</td>
                    <td>${dash}</td>
                `;
                tbodyA.appendChild(tr);
            });

            // --- Scenario B: With Twyne ---
            const tbodyB = document.querySelector('#scenarioBTable tbody');
            tbodyB.innerHTML = '';
            document.getElementById('scenarioBDeltaHeader').textContent = 'Delta vs Aave ' + aaveMaxInt + 'x';

            beyondLevels.forEach(lev => {
                const pos = positionDetails(equity, lev);
                const levPsi = minPsiForLeverage(lev, p.borrowLtvE, p.liqLtvE, p.betaSafe);
                const creditLpReq = pos.collateral / aaveMaxLev - equity;
                const twyneApy = twyneNetApy(lev, rSupply, rBorrow, irU, levPsi);
                const apyColor = twyneApy >= 0 ? 'var(--accent-green)' : 'var(--accent-orange)';

                const delta = twyneApy - aaveMaxNetApy;
                const deltaClass = delta >= 0 ? 'delta-positive' : 'delta-negative';
                const deltaStr = (delta >= 0 ? '+' : '') + (delta * 100).toFixed(2) + '%';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="color:var(--accent-blue);">${formatNum(creditLpReq)}</td>
                    <td>${lev}x</td>
                    <td>${formatNum(pos.collateral)}</td>
                    <td>${formatNum(pos.debt)}</td>
                    <td>${(pos.ltv * 100).toFixed(1)}%</td>
                    <td style="color:${apyColor};font-weight:600;">${(twyneApy * 100).toFixed(2)}%</td>
                    <td class="${deltaClass}">${deltaStr}</td>
                `;
                tbodyB.appendChild(tr);
            });

            _scenarioBeyondLevels = beyondLevels;
            updateRateSensitivityChart();
        }

        function updateRateSensitivityChart() {
            const p = getParams();
            const rSupply = p.stethStaking + p.stethLending;
            const irU = interestRate(p.utilization, p.iMin, p.i0, p.u0, p.iMax, p.gamma);
            const currentBorrow = p.ethBorrow;
            const currentSpread = (rSupply - currentBorrow) * 100;
            const td = TOKEN_DATA[_sensToken];

            const aaveLev = Math.floor(leverageFromLtv(p.borrowLtvE));

            // Purple palette for Twyne lines (light to dark)
            const purples = ['#c4a8ff', '#9c7cf4', '#7b5dd4', '#5e3fb5'];

            // Sweep spread values (yield - borrow) in %
            const steps = [];
            for (let bps = -400; bps <= 400; bps += 25) {
                steps.push(bps / 100);
            }

            // For a given spread, borrow = yield - spread
            function borrowFromSpread(spreadPct) {
                return rSupply - spreadPct / 100;
            }

            // Aave trace
            const aaveApys = steps.map(s => aaveNetApy(aaveLev, rSupply, borrowFromSpread(s)) * 100);

            const data = [{
                x: steps, y: aaveApys,
                type: 'scatter', mode: 'lines',
                name: 'Aave ' + aaveLev + 'x',
                line: { color: '#ef6c00', width: 2.5 },
                hovertemplate: '%{y:.2f}%',
            }];

            // Twyne traces — one per beyond-Aave level
            _scenarioBeyondLevels.forEach((lev, i) => {
                const levPsi = minPsiForLeverage(lev, p.borrowLtvE, p.liqLtvE, p.betaSafe);
                const ltv = 1 - 1 / lev;
                const apys = steps.map(s => loopedYield(rSupply, borrowFromSpread(s), ltv, irU, levPsi) * 100);
                data.push({
                    x: steps, y: apys,
                    type: 'scatter', mode: 'lines',
                    name: 'Twyne ' + lev + 'x',
                    line: { color: purples[i % purples.length], width: 2 },
                    hovertemplate: '%{y:.2f}%',
                });
            });

            // --- Historical spread distribution (yield - borrow) ---
            const binSize = 0.1;
            const yieldArr = td.yieldHist;
            const borrowArr = WETH_BORROW_HISTORY;
            const N = Math.min(yieldArr.length, borrowArr.length);
            const spreadBinCounts = {};
            for (let b = -4; b < 4; b = Math.round((b + binSize) * 100) / 100) spreadBinCounts[b] = 0;
            for (let i = 0; i < N; i++) {
                const spread = yieldArr[i] - borrowArr[i];
                const b = Math.round(Math.floor(spread / binSize) * binSize * 100) / 100;
                if (b >= -4 && b < 4) spreadBinCounts[b] = (spreadBinCounts[b] || 0) + 1;
            }
            const spreadBinX = Object.keys(spreadBinCounts).map(Number).sort((a, b) => a - b);
            const spreadBinY = spreadBinX.map(b => spreadBinCounts[b]);

            // Add histogram trace on secondary y-axis
            data.push({
                x: spreadBinX.map(b => b + binSize / 2),
                y: spreadBinY,
                type: 'bar',
                width: binSize * 0.9,
                yaxis: 'y2',
                marker: {
                    color: spreadBinX.map(b => b + binSize / 2 >= 0 ? 'rgba(76,175,80,0.35)' : 'rgba(239,108,0,0.3)'),
                    line: { color: spreadBinX.map(b => b + binSize / 2 >= 0 ? 'rgba(76,175,80,0.5)' : 'rgba(239,108,0,0.45)'), width: 0.5 },
                },
                hovertemplate: '%{x:.2f}%: %{y} days<extra></extra>',
                showlegend: false,
            });

            const shapes = [
                // Horizontal 0% line on main chart only
                { type: 'line', x0: steps[0], x1: steps[steps.length - 1], y0: 0, y1: 0, yref: 'y',
                  line: { color: 'rgba(255,255,255,0.15)', width: 1 } },
                // Current spread dashed vertical line (full height)
                { type: 'line', x0: currentSpread, x1: currentSpread, y0: 0, y1: 1, yref: 'paper',
                  line: { color: 'rgba(255,255,255,0.3)', width: 1, dash: 'dash' } },
                // 0% vertical line (full height — continuous through both subplots)
                { type: 'line', x0: 0, x1: 0, y0: 0, y1: 1, yref: 'paper',
                  line: { color: 'rgba(255,255,255,0.15)', width: 1 } },
            ];

            const annotations = [{
                x: currentSpread, y: 1, yref: 'paper',
                text: 'Current spread', showarrow: false,
                font: { size: 10, color: '#9aa0a6' },
                yanchor: 'top', xanchor: 'center',
                yshift: -4,
            }];

            const layout = {
                xaxis: {
                    range: [4, -4], autorange: false,
                    color: '#9aa0a6', gridcolor: 'rgba(138,155,181,0.1)',
                    ticksuffix: '%', dtick: 1, tickfont: { size: 10 },
                    zeroline: false,
                    anchor: 'y2',
                    title: { text: 'Spread', font: { size: 10, color: '#9aa0a6' }, standoff: 6 },
                },
                yaxis: {
                    domain: [0.22, 1.0],
                    title: { text: 'Net APY (%)', font: { size: 11 } },
                    color: '#9aa0a6', gridcolor: 'rgba(138,155,181,0.1)',
                    ticksuffix: '%', tickfont: { size: 10 }, zeroline: false,
                    anchor: 'free', position: 0,
                    ticklabeloverflow: 'hide past domain',
                },
                yaxis2: {
                    domain: [0, 0.17],
                    color: '#9aa0a6', gridcolor: 'rgba(138,155,181,0.05)',
                    tickfont: { size: 9 }, showticklabels: true,
                    title: { text: 'Daily Spread Distribution', font: { size: 9, color: '#9aa0a6' } },
                },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                margin: { t: 30, r: 20, b: 36, l: 54 },
                bargap: 0,
                legend: {
                    x: 1, y: 1, xanchor: 'right', yanchor: 'top',
                    bgcolor: 'rgba(35,43,59,0.8)',
                    font: { color: '#e8eaed', size: 10 },
                },
                hovermode: 'x unified',
                hoverlabel: {
                    bgcolor: 'rgba(26,31,46,0.95)',
                    bordercolor: 'var(--border-color)',
                    font: { size: 12, color: '#e8eaed' },
                },
                shapes: shapes,
                annotations: annotations,
            };

            Plotly.newPlot('rateSensitivityChart', data, layout, { responsive: true, displayModeBar: false });

            // Update source text
            document.getElementById('sensitivitySourceText').textContent =
                "Source: DeFi Llama, May '24 – Feb '26 — WETH borrow rate (Aave V3) · " + td.source;

            // --- Shared trace data ---
            function findZeroCrossing(xArr, yArr) {
                for (let i = 1; i < yArr.length; i++) {
                    if ((yArr[i - 1] >= 0 && yArr[i] < 0) || (yArr[i - 1] < 0 && yArr[i] >= 0)) {
                        const ratio = yArr[i - 1] / (yArr[i - 1] - yArr[i]);
                        return xArr[i - 1] + ratio * (xArr[i] - xArr[i - 1]);
                    }
                }
                return null;
            }

            const allTraces = [{ name: 'Aave ' + aaveLev + 'x', apys: aaveApys, color: '#ef6c00', lev: aaveLev, isAave: true }];
            _scenarioBeyondLevels.forEach((lev, i) => {
                allTraces.push({ name: 'Twyne ' + lev + 'x', apys: data[i + 1].y, color: purples[i % purples.length], lev: lev, isAave: false });
            });

            // --- Sensitivity table (by ETH borrow rate) ---
            const checkRates = [2, 4, 6, 8];
            const sensHeader = document.getElementById('sensitivityHeader');
            sensHeader.innerHTML = '<th style="text-align:left;">Position</th>';
            checkRates.forEach(r => {
                const isCurrent = Math.abs(r - currentBorrow * 100) < 0.5;
                const highlight = isCurrent ? ' style="color:var(--text-primary);"' : '';
                sensHeader.innerHTML += '<th' + highlight + '>' + r + '%</th>';
            });

            const sensBody = document.getElementById('sensitivityBody');
            sensBody.innerHTML = '';
            allTraces.forEach(t => {
                const tr = document.createElement('tr');
                let cells = '<td style="color:' + t.color + ';font-weight:600;">' + t.name + '</td>';
                checkRates.forEach(r => {
                    const rBorrow = r / 100;
                    let apy;
                    if (t.isAave) {
                        apy = aaveNetApy(t.lev, rSupply, rBorrow) * 100;
                    } else {
                        const levPsi = minPsiForLeverage(t.lev, p.borrowLtvE, p.liqLtvE, p.betaSafe);
                        const ltv = 1 - 1 / t.lev;
                        apy = loopedYield(rSupply, rBorrow, ltv, irU, levPsi) * 100;
                    }
                    const color = apy >= 0 ? 'var(--accent-green)' : '#7a7f85';
                    cells += '<td style="color:' + color + ';font-weight:600;">' + apy.toFixed(2) + '%</td>';
                });
                tr.innerHTML = cells;
                sensBody.appendChild(tr);
            });
        }

        // =====================================================================
        // Historical Analysis Charts
        // =====================================================================
        function setSensToken(token) {
            _sensToken = token;
            ['rseth', 'eeth', 'steth'].forEach(t => {
                const btn = document.getElementById('sensToggle_' + t);
                btn.style.background = t === token ? 'var(--accent-purple)' : 'transparent';
                btn.style.color = t === token ? '#fff' : 'var(--text-muted)';
            });
            updateRateSensitivityChart();
            updateHistoricalCharts();
        }

        function updateHistoricalCharts() {
            const p = getParams();
            const irU = interestRate(p.utilization, p.iMin, p.i0, p.u0, p.iMax, p.gamma);

            // Select dataset based on toggle
            const td = TOKEN_DATA[_sensToken];
            const hDates = td.histDates;
            const hStake = td.histStake;
            const hBorrow = td.histBorrow;
            const tokenLabel = td.label;
            const N = hDates.length;

            const darkLayout = {
                paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                font: { color: '#9aa0a6', size: 11 },
                margin: { t: 30, r: 20, b: 40, l: 54 },
                hovermode: 'x unified',
                hoverlabel: { bgcolor: '#292a2d', bordercolor: '#5f6368', font: { color: '#e8eaed', size: 12 } },
            };
            const plotCfg = { responsive: true, displayModeBar: false };
            const gridColor = 'rgba(138,155,181,0.1)';

            // --- Build all traces for combined subplot ---
            const spread = hStake.map((s, i) => +(s - hBorrow[i]).toFixed(3));
            const aaveLev = leverageFromLtv(p.borrowLtvE);
            const purples = ['#c4a8ff', '#9c7cf4', '#7b5dd4', '#5e3fb5'];
            const beyondLevels = _scenarioBeyondLevels.length > 0 ? _scenarioBeyondLevels : [4, 6, 8, 10];
            const hexToRgba = (hex, a) => {
                const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
                return `rgba(${r},${g},${b},${a})`;
            };

            const leverageConfigs = [
                { name: 'Aave ' + aaveLev.toFixed(1) + 'x', lev: aaveLev, color: '#ef6c00', isAave: true }
            ];
            beyondLevels.forEach((lev, i) => {
                const levPsi = minPsiForLeverage(lev, p.borrowLtvE, p.liqLtvE, p.betaSafe);
                leverageConfigs.push({ name: 'Twyne ' + lev + 'x', lev: lev, psi: levPsi, color: purples[i % purples.length], isAave: false });
            });

            const allTraces = [];
            const drawdownStats = [];

            // Subplot 1: Rate Spread (top)
            allTraces.push({
                x: hDates, y: spread, type: 'scatter', mode: 'lines',
                line: { color: '#9aa0a6', width: 1.2 },
                xaxis: 'x', yaxis: 'y',
                showlegend: false,
            });

            // Subplot 2 & 3: ROI + Drawdown per leverage config
            leverageConfigs.forEach(cfg => {
                const capital = new Array(N);
                const ddSeries = new Array(N);
                let peak = -Infinity;
                let maxDD = 0;

                for (let i = 0; i < N; i++) {
                    const rS = hStake[i] / 100;
                    const rB = hBorrow[i] / 100;
                    let netApy;
                    if (cfg.isAave) {
                        netApy = aaveNetApy(cfg.lev, rS, rB);
                    } else {
                        const ltv = 1 - 1 / cfg.lev;
                        netApy = loopedYield(rS, rB, ltv, irU, cfg.psi);
                    }

                    if (i === 0) {
                        capital[i] = 1.0;
                    } else {
                        capital[i] = capital[i - 1] * (1 + netApy / 365);
                    }
                    if (capital[i] > peak) peak = capital[i];
                    const dd = (peak - capital[i]) / peak;
                    ddSeries[i] = -(dd * 100);
                    if (dd > maxDD) maxDD = dd;
                }

                drawdownStats.push({ name: cfg.name, color: cfg.color, maxDD });

                // ROI trace (subplot 2)
                allTraces.push({
                    x: hDates, y: capital, name: cfg.name, type: 'scatter', mode: 'lines',
                    line: { color: cfg.color, width: 1.3 },
                    xaxis: 'x2', yaxis: 'y2',
                    legendgroup: cfg.name,
                });

                // Drawdown trace (subplot 3)
                allTraces.push({
                    x: hDates, y: ddSeries, name: cfg.name, type: 'scatter', mode: 'lines',
                    line: { color: cfg.color, width: 1.2 },
                    fill: 'tozeroy', fillcolor: hexToRgba(cfg.color, 0.08),
                    xaxis: 'x3', yaxis: 'y3',
                    showlegend: false,
                    legendgroup: cfg.name,
                });
            });

            const subplotLayout = {
                ...darkLayout,
                grid: { rows: 3, columns: 1, subplots: [['xy'], ['x2y2'], ['x3y3']], roworder: 'top to bottom' },
                xaxis:  { color: '#9aa0a6', gridcolor: gridColor, matches: 'x3', showticklabels: false },
                xaxis2: { color: '#9aa0a6', gridcolor: gridColor, matches: 'x3', showticklabels: false },
                xaxis3: { color: '#9aa0a6', gridcolor: gridColor },
                yaxis:  { color: '#9aa0a6', gridcolor: gridColor, ticksuffix: '%', zeroline: true, zerolinecolor: 'rgba(255,255,255,0.3)', zerolinewidth: 1.5, title: { text: 'Rate Spread', font: { size: 11, color: '#9aa0a6' } } },
                yaxis2: { color: '#9aa0a6', gridcolor: gridColor, tickprefix: '$', zeroline: false, title: { text: 'Cumulative ROI', font: { size: 11, color: '#9aa0a6' } } },
                yaxis3: { color: '#9aa0a6', gridcolor: gridColor, ticksuffix: '%', zeroline: true, zerolinecolor: 'rgba(255,255,255,0.25)', zerolinewidth: 1, title: { text: 'Drawdown', font: { size: 11, color: '#9aa0a6' } } },
                showlegend: false,
                annotations: [
                    { text: 'Rate Spread (' + tokenLabel + ' Yield − WETH Borrow)', xref: 'paper', yref: 'y domain', x: 0, y: 1, xanchor: 'left', yanchor: 'bottom', showarrow: false, font: { size: 12, color: '#e8eaed' } },
                    { text: 'Cumulative ROI ($1 Invested)', xref: 'paper', yref: 'y2 domain', x: 0, y: 1, xanchor: 'left', yanchor: 'bottom', showarrow: false, font: { size: 12, color: '#e8eaed' } },
                    { text: 'Drawdown from Peak', xref: 'paper', yref: 'y3 domain', x: 0, y: 1, xanchor: 'left', yanchor: 'bottom', showarrow: false, font: { size: 12, color: '#e8eaed' } },
                ],
                shapes: [{ type: 'line', xref: 'x2', yref: 'y2', x0: hDates[0], x1: hDates[N - 1], y0: 1, y1: 1,
                    line: { color: 'rgba(255,255,255,0.3)', width: 1.5, dash: 'dash' } }],
            };

            Plotly.newPlot('histCombinedChart', allTraces, subplotLayout, plotCfg);

        }

        function updateAll() {
            updateStats();
            updateHeatmap();
            updateKeyInsight();
            updateTvlTradeoffChart();
            updateIrmChart();
            updateTvlMultiplierHeatmap();
            updatePositionComparison();
            updateHistoricalCharts();
        }

        // Number formatting helper
        function formatWithCommas(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // CLP input formatting
        ['clpDeposited', 'borrowerEquity'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('focus', function() {
                this.value = this.value.replace(/,/g, '');
            });
            el.addEventListener('blur', function() {
                const num = parseInt(this.value.replace(/,/g, ''), 10);
                if (!isNaN(num)) {
                    this.value = formatWithCommas(num);
                }
            });
        });

        // Add event listeners to all inputs
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', updateAll);
        });


        // Visual warning when liqLtvT < liqLtvE (don't lock the value)
        const liqLtvTInput = document.getElementById('liqLtvT');
        const liqLtvEInput = document.getElementById('liqLtvE');
        function checkLtvValidity() {
            const tVal = parseFloat(liqLtvTInput.value);
            const eVal = parseFloat(liqLtvEInput.value);
            if (!isNaN(tVal) && !isNaN(eVal) && tVal < eVal) {
                liqLtvTInput.style.borderColor = 'var(--accent-orange)';
                liqLtvTInput.style.boxShadow = '0 0 0 1px var(--accent-orange)';
            } else {
                liqLtvTInput.style.borderColor = '';
                liqLtvTInput.style.boxShadow = '';
            }
        }
        liqLtvTInput.addEventListener('input', checkLtvValidity);
        liqLtvEInput.addEventListener('input', checkLtvValidity);

        // Tradeoff table HF listener
        document.getElementById('tradeoffHfInput').addEventListener('input', updateTvlTradeoffChart);

        // More Analytics: render charts on open
        const moreAnalyticsEl = document.getElementById('moreAnalyticsDetails');
        if (moreAnalyticsEl) {
            moreAnalyticsEl.addEventListener('toggle', function() {
                if (this.open) {
                    updateTvlMultiplierHeatmap();
                }
            });
        }

        // Initial render
        updateAll();

        // Tooltip — appended to body so grid overflow can't clip it
        const tip = document.createElement('div');
        tip.id = 'tip';
        document.body.appendChild(tip);

        document.addEventListener('mouseover', e => {
            const th = e.target.closest('th[data-tip]');
            if (!th) return;
            tip.textContent = th.getAttribute('data-tip');
            tip.style.opacity = '1';
            const r = th.getBoundingClientRect();
            tip.style.left = r.left + r.width / 2 - tip.offsetWidth / 2 + 'px';
            tip.style.top = r.top - tip.offsetHeight - 6 + 'px';
        });

        document.addEventListener('mouseout', e => {
            if (e.target.closest('th[data-tip]')) tip.style.opacity = '0';
        });

        // Sidebar toggle
        const container = document.querySelector('.container');
        function resizePlots() {
            document.querySelectorAll('.js-plotly-plot').forEach(el => Plotly.Plots.resize(el));
        }
        container.addEventListener('transitionend', e => {
            if (e.propertyName === 'grid-template-columns') resizePlots();
        });
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            container.classList.add('sidebar-closed');
        });
        document.getElementById('sidebarOpen').addEventListener('click', () => {
            container.classList.remove('sidebar-closed');
        });
    </script>
</body>
</html>
